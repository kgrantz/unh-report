---
output: 
  html_document:
    toc: TRUE
    toc_depth: 3
    toc_float: TRUE
    theme: journal
params:
  run_checks: FALSE # whether to run and print out basic data checks
  show_cleaning: FALSE # whether to print out basic info about data cleaning steps
  concord: TRUE #indicate whether to run extra graphics for concord
  manchester: TRUE #indicate whether to run extra graphics for manchester
  report_date: "2020-11-06" # date in YYYY-MM-DD
  state_conditions: "Limited Open"
---


```{r setup, include=FALSE}
  knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.topcaption = TRUE)
  knitr::opts_knit$set(eval.after = 'fig.cap')

  fig_counter <- 1
  tab_counter <- 1

  
  library(tidyverse)
  library(glue)
  library(colorspace)
  library(flextable)
  library(lubridate)
  library(rvest)
  library(scales)
  library(sf)
  library(ggrepel)
  library(lwgeom)
  library(officer)
  library(tibbletime)
  
  pick_color_threshold <- function(value, 
                                   thresholds, 
                                   colors=c("#8bcca3", "#f0e37f", "#e6b367", "#de6e66")){
  return(colors[max(which(value > thresholds))])
  }
  
  pick_color_threshold_str <- function(value, 
                                       thresholds, 
                                       strings=c("Green", "Yellow", "Orange", "Red")){
  return(strings[max(which(value > thresholds))])
  }
    
```

```{r data-load, warning = params$run_checks}

  routinetesting <- read_csv("raw_data/routinetesting.csv") %>%
                    mutate(resultsdate = as.Date(resultsdate),
                           collectdate = as.Date(collectdate),
                           onsetdate = as.Date(onsetdate))

  isolationquarantine <- read_csv("raw_data/isolationquarantine.csv")

  individualdemographics <- read_csv("raw_data/individualdemographics.csv")

```

```{r params}

  report_date <- as.Date(params$report_date)
  report_date_str_long <- as.character(format(report_date, format="%B %d, 2020"))
  report_date_str_short <- as.character(format(report_date, format="%b %d"))
  
  # Date on which report begins (inclusive)
  start_date <- report_date - 6
  start_date_str_long <- as.character(format(start_date, format="%B %d, 2020"))
  start_date_str_short <- as.character(format(start_date, format="%b %d"))
  
  # Date to which active cases are counted
  report_date_minus10 <- report_date - 10
  
  # one week date (exclusive)
  report_date_minus7 <- report_date - 7
  report_date_minus7_str_short <- as.character(format(report_date_minus7, format="%b %d"))
  
  # two week date
  report_date_minus14 <- report_date - 14

  # common axis limits
  xaxis_reporting <- c(start_date-0.5, report_date+0.5)
  xaxis_entire <- c(as.Date("2020-08-10")-0.5, report_date+0.5)
```


```{r demo-checks, eval=params$run_checks}
  ## print out missingness in demographics
  summary(is.na(individualdemographics))

  ## print out how many repeat IDs there are by campus and user status
  individualdemographics %>%
          group_by(uid) %>%
          summarize(n = n(),
                    campus = campus[1],
                    user_status = user_status[1]) %>%
          filter(n > 1) %>%
          ungroup() %>%
          group_by(campus, user_status) %>%
          summarize(n = n())

```

```{r demo-duplicates}
  
  ## remove duplicates if they still exist
  ## favor entries that have complete campus, age, user_status where available
  ## logic: add number of missing values (of campus, age, user_status, )
  ## arrange data so that NAs are last, then fill in NAs
  ## keep the row that had the fewest elements filled in
  individualdemographics <- individualdemographics %>%
                            group_by(uid) %>%
                            mutate(n_missing = sum(is.na(c(user_status, sex, age, campus)), na.rm=TRUE)) %>%
                            arrange(user_status) %>%
                            fill(user_status) %>%
                            arrange(sex) %>%
                            fill(sex) %>%
                            arrange(age) %>%
                            fill(age) %>%
                            arrange(campus) %>%
                            fill(campus) %>%
                            arrange(n_missing) %>%
                            mutate(n = 1:n()) %>%
                            ungroup() %>%
                            filter(n==1)
        
```


```{r demo-recoding, include=params$show_cleaning}

  ## numeric categorical for user_status
  ## 0, student; 1, faculty; 2, staff; 3, employee; 4, unknown
  table(individualdemographics$user_status)
  individualdemographics <- individualdemographics %>%
                            mutate(user_status = tolower(user_status)) %>%
                            mutate(user_status_num = recode(user_status,
                                                            student = 0,
                                                            faculty = 1,
                                                            staff = 2,
                                                            employee = 3,
                                                            unknown = 4),
                                   user_status_fac = factor(user_status_num,
                                                            levels = 0:4,
                                                            labels = c("Student", "Faculty", "Staff", "Employee", "Unknown"))) 
  table(individualdemographics$user_status, individualdemographics$user_status_num)
  table(individualdemographics$user_status, individualdemographics$user_status_fac)
  
  ## numeric age categories
  ## [15, 20), then 10y bins to 80+
  table(individualdemographics$age)
  individualdemographics <- individualdemographics %>%
                            mutate(age_cat = cut(age, breaks=c(15, seq(20, 60, 10), 200), right = FALSE),
                                   age_cat_num = as.numeric(age_cat),
                                   age_cat = factor(age_cat,
                                                    labels = c("15-19", "20-29", "30-39", "40-49", "50-59", "60+")))
  table(individualdemographics$age_cat_num, individualdemographics$age_cat)
  table(individualdemographics$age, individualdemographics$age_cat)

  ## numeric gender categories from `sex`
  table(individualdemographics$sex)
  individualdemographics <- individualdemographics %>%
                            mutate(sex = tolower(sex)) %>%
                            mutate(gender=recode(sex,
                                                 "cisgender man"="Assigned Male at Birth",
                                                 "cisgender woman"="Assigned Female at Birth",
                                                 "male"="Assigned Male at Birth",
                                                 "female"="Assigned Female at Birth",
                                                 "transgender man"= "Trans Man",
                                                 "transgender woman"= "Trans Woman",
                                                 "gender non-conforming"= "Genderqueer/Non-binary (GNB)",
                                                 "gender queer"="Genderqueer/Non-binary (GNB)",
                                                 "non-binary"= "Genderqueer/Non-binary (GNB)",
                                                 "my identity is not listed"= "Not listed or prefer not to say",
                                                 "prefer not to say"="Not listed or prefer not to say"
                                                 )) %>%
                            mutate(gender=factor(gender,levels=c("Assigned Male at Birth",
                                                                 "Assigned Female at Birth",
                                                                 "Trans Man",
                                                                 "Trans Woman",
                                                                 "Genderqueer/Non-binary (GNB)",
                                                                 "Not listed or prefer not to say"))) %>%
                            mutate(gender_num = as.numeric(gender) - 1)
    table(individualdemographics$sex, individualdemographics$gender)
    table(individualdemographics$gender_num, individualdemographics$gender)
                                        

  ## numeric campus indicator
  ## 0 "Durham"; 1 "Concord (Law)"; 2 "Manchester"; 3 "Other"
  table(individualdemographics$campus)
  individualdemographics <- individualdemographics %>%
                            mutate(campus = tolower(campus)) %>%
                            mutate(campus_num=recode(campus,
                                                 "unh durham" = 0,
                                                 "unh law"= 1,
                                                 "unh manchester" = 2,
                                                 "other" = 3,
                                                  )) %>%
                            mutate(campus_num=ifelse(is.na(campus_num),4,campus_num)) %>%
                            mutate(campus_fac=factor(campus_num,
                                                     levels = 0:4,
                                                     labels = c("UNH Durham","UNH Law","UNH Manchester","Other","Missing")),
                                   campus_num=as.numeric(campus_fac)-1)
  table(individualdemographics$campus, individualdemographics$campus_fac)
  table(individualdemographics$campus_num, individualdemographics$campus_fac)

  ## numeric program result
	## 0 "Lib Arts"; 1 "Business";	2 "Agriculture"; 3 "Engineering"; 4 "Health"; 5 "Graduate School";
  ## 6 "Continuing Ed"; 7 "Manchester"; 8 "Law";	9 "Applied Sciences"
  table(individualdemographics$college)
  individualdemographics <- individualdemographics %>%
                            mutate(college_num = tolower(college),
                                   college_num = str_replace(college_num, ".*liberal arts.*", "0"),
                                   college_num = str_replace(college_num, ".*business.*", "1"),
                                   college_num = str_replace(college_num, ".*life science.*", "2"),
                                   college_num = str_replace(college_num, ".*engineer.*", "3"),
                                   college_num = str_replace(college_num, ".*health.*", "4"),
                                   college_num = str_replace(college_num, ".*graduate.*", "5"),
                                   college_num = str_replace(college_num, ".*continuing.*", "6"),
                                   college_num = str_replace(college_num, ".*manchester.*", "7"),
                                   college_num = str_replace(college_num, ".*law.*", "8"),
                                   college_num = str_replace(college_num, ".*applied.*", "9"),
                                   college_num = str_replace(college_num, ".*designated.*", "10")) %>%
                            mutate(college_num = as.numeric(college_num)) %>%
                            mutate(college_fac = factor(college_num,
                                                        levels = 0:10,
                                                        labels = c("Liberal Arts",
                                                                   "Business",
                                                                   "Agriculture/Life Sci",
                                                                   "Engineering/Phys Sci",
                                                                   "Health",
                                                                   "Graduate School",
                                                                   "Continuing Ed",
                                                                   "Manchester",
                                                                   "Law",
                                                                   "Applied Sciences",
                                                                   "No college designated")))
  table(individualdemographics$college, individualdemographics$college_fac)
  table(individualdemographics$college_num, individualdemographics$college_fac)

  
  ## dorimtory + on/off campus levels
  ## On/Off: 1 if no dorm listed
  ## Dorm: 0 "Hills" 1 "Valley" 2 "Timbers" 3 "Woodside Apts" 4 "Gables Apts"
      # note the that no students are listed in the isolation and quarantine dorm:
      # https://www.unh.edu/housing/residence-halls
      # Adams Tower West and Babcock Hall are being utilized as UNH's isolation and quarantine dorms.
      # Adams Tower West has single rooms with ensuite bathrooms.
      # Babcock Hall offers single residence hall rooms with community bathrooms.
      # Students assigned to the Quarantine or Isolation Halls will be provided meals, snacks and beverages.

  table(individualdemographics$dorm)
  individualdemographics <- individualdemographics %>%
                            mutate(off_campus_num=ifelse(is.na(dorm), 1, 0),
                                   off_campus_fac = factor(off_campus_num,
                                                          levels = 0:1,
                                                          labels = c("On Campus", "Off Campus"))) %>%
                            mutate(dorm_group=recode(dorm,
                                                     "Alexander Hall"= "The Valley", 
                                                     "Christensen Hall"= "The Timbers",
                                                     "Congreve Hall"= "The Hills",
                                                     "Devine Hall" = "Upper Quad",
                                                     "Eaton House" = "The Minis",
                                                     "Engelhardt Hall"="The Valley",
                                                     "Fairchild Hall"="The Valley",
                                                     "Gables North" = "Gables Apts",   
                                                     "Gables South" = "Gables Apts",       
                                                     "Gibbs Hall"= "The Valley",
                                                     "Haaland Hall" = "The Timbers",
                                                     "Hall House" = "The Minis",
                                                     "Handler Hall"= "The Timbers",
                                                     "Hetzel Hall" = "The Valley",
                                                     "Hitchcock Hall"= "Upper Quad",
                                                     "Hubbard Hall" = "The Timbers",
                                                     "Hunter Hall" = "The Valley",
                                                     "Jessie Doe Hall"="The Hills", 
                                                     "Lord Hall"="The Hills",    
                                                     "Marston House" = "The Minis",
                                                     "Mclaughlin Hall"="The Hills",
                                                     "Mills Hall"="The Valley",
                                                     "Peterson Hall"="The Timbers",
                                                     "Randall Hall" = "Upper Quad",
                                                     "Richardson House" = "The Minis",
                                                     "Sawyer Hall"="The Hills",
                                                     "Scott Hall"="The Hills",
                                                     "Stoke Hall"="The Hills",
                                                     "The Gables - A" = "Gables Apts",
                                                     "The Gables - B" = "Gables Apts",
                                                     "The Gables - C" = "Gables Apts",
                                                     "Williamson Hall"="The Timbers",
                                                     "Woodside Apts. A" = "Woodside Apts",
                                                     "Woodside Apts. B" = "Woodside Apts",
                                                     "Woodside Apts. C" = "Woodside Apts",
                                                     "Woodside Apts. D" = "Woodside Apts",
                                                     "Woodside Apts. E" = "Woodside Apts",
                                                     "Woodside Apts. F" = "Woodside Apts",
                                                     "Woodside Apts. G" = "Woodside Apts",
                                                     "Woodside Apts. H"= "Woodside Apts",
                                                     "Woodside Apts. I"= "Woodside Apts",
                                                     "Woodside Apts. J"= "Woodside Apts",
                                                     "Woodside Apts. K"= "Woodside Apts",
                                                     "Woodside Apts. L"= "Woodside Apts",
                                                     "Woodside Apts. M"= "Woodside Apts",
                                                     "Woodside Apts. N"= "Woodside Apts",
                                                     "Woodside Apts. O"= "Woodside Apts",
                                                     "Woodside Apts. P"= "Woodside Apts",
                                                     "Woodside Apts. Q"= "Woodside Apts",
                                                     "Woodside Apts. R"= "Woodside Apts")) %>%
                            mutate(dorm_group_num = recode(dorm_group,
                                                           "The Hills" = 0,
                                                           "The Valley" = 1,
                                                           "The Timbers" = 2,
                                                           "Woodside Apts" = 3,
                                                           "Gables Apts" = 4),
                                   dorm_group = as.factor(dorm_group))
  table(individualdemographics$dorm, individualdemographics$off_campus_num)
  table(individualdemographics$off_campus_fac, individualdemographics$off_campus_num)
  table(individualdemographics$dorm, individualdemographics$dorm_group)
  table(individualdemographics$dorm_group_num, individualdemographics$dorm_group)

```


```{r demo-testing-merge}
  
  ## merge the testing and demographics datasets
  demo_testing <- routinetesting %>%
                    left_join(individualdemographics, by="uid")
    
```


```{r demo-testing-merge-checks, eval=params$run_checks}

  ## missingness
  summary(is.na(demo_testing))

  ## are the dimensions of `demo_testing` the same as `routine_testing`
  nrow(demo_testing) == nrow(routinetesting)

  ## how many IDs have no testing information ever, in last 1 week, or in last 2 weeks? 
  tmp <- demo_testing %>%
         mutate(tested_1week = ifelse((resultsdate > report_date_minus7 & resultsdate <= report_date) | 
                               (collectdate > report_date_minus7 & collectdate <= report_date), 1, 0),
                tested_2week = ifelse((resultsdate > report_date_minus14 & resultsdate <= report_date) | 
                               (collectdate > report_date_minus14 & collectdate <= report_date), 1, 0))
  
  individualdemographics %>%
    group_by(campus, user_status) %>%
    summarise(n_never_tested = sum(!(uid %in% tmp$uid), na.rm=TRUE),
              n_not_tested_2week = sum(!(uid %in% tmp$uid[tmp$tested_2week==1])),
              n_not_tested_1week = sum(!(uid %in% tmp$uid[tmp$tested_1week==1])))
  
  ## how complete does the testing data look for report period?
  ## using collectdate, which appears to be more complete
  tmp %>%
    filter(tested_1week == 1) %>%
    group_by(collectdate) %>%
    summarise(n_tests = n())
  
```


```{r isolation-recoding, include=params$show_cleaning}

  ## Recoding dates, date-times
  isolationquarantine <- isolationquarantine %>%
                         mutate(quar_entrydttm = as.POSIXct(quar_entrydate),
                                quar_exitdttm = as.POSIXct(quar_exitdate),
                                quar_exposuredttm = as.POSIXct(quar_exposuredate),
                                iso_entrydttm = as.POSIXct(iso_entrydate),
                                iso_exitdttm = as.POSIXct(iso_exitdate),
                                quar_entrydate = as.Date(quar_entrydate),
                                quar_exitdate = as.Date(quar_exitdate),
                                quar_exposuredate = as.Date(quar_exposuredate),
                                iso_entrydate = as.Date(iso_entrydate),
                                iso_exitdate = as.Date(iso_exitdate),
                                notifydttm = as.POSIXct(notifydate),
                                notifydate = as.Date(notifydate))

  ## Recoding location
  table(isolationquarantine$location)
  table(isolationquarantine$dorm)
  isolationquarantine <- isolationquarantine %>%
                         mutate(quar_isol_bed = ifelse(location=="Campus", 1, 0)) %>%
                         rename(dorm_isol = dorm)
  
  isolationquarantine <- isolationquarantine %>%
                         mutate(location_num = recode(location,
                                                      "Campus" = 1,
                                                       "Home" = 2,
                                                       "Off-Campus - A/O" = 3,
                                                       "Off-Campus - Durham" = 4,
                                                       .default=5)) %>%
                         mutate(location_old = location,
                                location = factor(location_num,
                                                  levels = 1:5,
                                                  labels = c("Campus", "Home", "Off-Campus - A/O", "Off-Campus - Durham", "Other Campus/Unknown")))
    
  
```

```{r demo-isolation-merge}

  ## merge the isolation and demographics datasets
  demo_isol <- isolationquarantine %>%
               left_join(individualdemographics, by="uid")

```


```{r demo-isolation-checks, eval=params$run_checks}

  ## how many isolation/quar events don't have demo data?
  summary(is.na(demo_isol))
  
  ## how many listed more than once?
  demo_isol %>%
    mutate(quar_ind = ifelse(is.na(quar_entrydate), 0, 1),
           isol_ind = ifelse(is.na(iso_entrydate), 0, 1)) %>%
    group_by(uid) %>%
    summarise(n = n(),
              n_quar = sum(quar_ind),
              n_isol = sum(isol_ind)) %>%
    ungroup() %>%
    summarise(n_quar_morethanonce = sum(n_quar>1, na.rm=TRUE),
              n_quar_morethantwice = sum(n_quar>2, na.rm = TRUE),
              n_isol_morethanonce = sum(n_isol>1, na.rm=TRUE),
              n_quar_and_isol = sum(n_isol>0 & n_quar>0, na.rm = TRUE))
  
  ## any overlapping quarantine periods?
  demo_isol %>%
    group_by(uid) %>%
    filter(sum(!is.na(quar_entrydate)) > 1) %>%
    arrange(uid, quar_entrydate) %>%
    mutate(prev_quarexit = lag(quar_exitdate)) %>%
    mutate(overlap = ifelse(prev_quarexit > quar_entrydate, 1, 0)) %>%
    ungroup() %>%
    filter(overlap==1) %>%
    group_by(campus, user_status) %>%
    summarise(n_overlapping_quar = n())

```

```{r isol-duplicates}
  
  ## remove duplicate/overlapping quarantines if they still exist
  ## favor entries that have complete notification date, location, isolation dorm
  ## first, find the IDs that have overlapping quarantine periods + the two overlapping entries
  ## then select the one to remove

  demo_isol <- demo_isol %>%
               mutate(ind = 1:n())

  to_rm <- demo_isol %>%
           group_by(uid) %>%
           filter(sum(!is.na(quar_entrydate)) > 1) %>%
           arrange(uid, quar_entrydate) %>%
           mutate(prev_quarexit = lag(quar_exitdate)) %>%
           mutate(overlap = ifelse(prev_quarexit > quar_entrydate, 1, 0)) %>%
           mutate(overlap = max(overlap, na.rm = TRUE)) %>%
           filter(overlap == 1) %>%
           mutate(n_missing = sum(is.na(c(as.character(notifydate), location)), na.rm=TRUE)) %>%
           arrange(desc(n_missing)) %>%
           mutate(n = 1:n()) %>%
           ungroup() %>%
           filter(n==1)

  demo_isol <- demo_isol %>%
               filter(!(ind %in% to_rm$ind))
        
```

```{r isol-reformat, include=params$run_checks}

  ## create df of only quarantine events
  demo_quar <- demo_isol %>%
               filter(!is.na(quar_entrydate))

  ## any weird dates?
  reasonable_dates <- as.Date(as.Date("2020-01-01"):as.Date("2021-01-01"), origin="1970-01-01")
  demo_quar %>%
    filter(!(quar_entrydate %in% reasonable_dates) | !(quar_exitdate %in% reasonable_dates)) %>%
    group_by(campus_fac, user_status_fac) %>%
    summarise(n_weird_quar_dates=n())

  ## TO DO: for now, filtering out those weird dates
  demo_quar <- demo_quar %>%
               filter((quar_entrydate %in% reasonable_dates) & (quar_exitdate %in% reasonable_dates))
  
  ## create df of only isolation events
  ## checks whether dates are reasonable
  ## filters to only include those reasonable events
  demo_isol <- demo_isol %>%
               filter(!is.na(iso_entrydate))
  
  demo_isol %>%
    filter(!(iso_entrydate %in% reasonable_dates) | !(iso_exitdate %in% reasonable_dates)) %>%
    group_by(campus_fac, user_status_fac) %>%
    summarise(n_weird_isol_dates=n())

  demo_isol <- demo_isol %>%
               filter((iso_entrydate %in% reasonable_dates) & (iso_exitdate %in% reasonable_dates))
  
  
  ## create long quarantine dataset (1 row per ID, per day in quarantine)
  ## TO DO: this imputes any missing exit dates with the entry date + 14
  demo_quar_long <- demo_quar %>%
                    mutate(quar_exitdate = ifelse(is.na(quar_exitdate) & !is.na(quar_entrydate),
                                                        quar_entrydate + 14,
                                                        quar_exitdate)) %>%
                    mutate(quar_exitdate = as.Date(quar_exitdate, origin="1970-01-01")) %>%
                    rowwise() %>% 
                    do(data.frame(date = .$quar_entrydate:.$quar_exitdate,
                                  uid = .$uid,
                                  location = .$location,
                                  dorm_isol = .$dorm_isol,
                                  quar_isol_bed = .$quar_isol_bed,
                                  campus_fac = .$campus_fac,
                                  off_campus_fac = .$off_campus_fac,
                                  user_status_fac = .$user_status_fac))
  
  demo_isol_long <- demo_isol %>%
                    replace_na(list(iso_exitdate = report_date)) %>%
                    rowwise() %>% 
                    do(data.frame(date = .$iso_entrydate:.$iso_exitdate,
                                  uid = .$uid,
                                  location = .$location,
                                  dorm_isol = .$dorm_isol,
                                  quar_isol_bed = .$quar_isol_bed,
                                  campus_fac = .$campus_fac,
                                  off_campus_fac = .$off_campus_fac,
                                  user_status_fac = .$user_status_fac))
```

```{r demo-testing-long-cleaning, include=params$show_cleaning}

	## Rename variables to be more accurate: collectdate > labeldate, collecttime > labeltime
	demo_testing <- demo_testing %>%
                  rename(labeldate = collectdate,
                         labeltime = collecttime)

  ## numeric test result
	## 0 "Neg"; 1 "Pos"; 2 "Inconclusive"; 3 "Invalid/Rejected/No Result"
  table(tolower(demo_testing$result))
  demo_testing <- demo_testing %>%
                  mutate(result = tolower(result)) %>%
                  mutate(result_num = recode(result,
                                             "negative" = 0,
                                             "positive" = 1,
                                             "test was positive provided letter to be on campus" = 1,
                                             "inconclusive" = 2,
                                             .default = 3)) %>%
                  mutate(result_fac = factor(result_num,
                                             levels = 0:3,
                                             labels = c("Negative", "Positive", "Inconclusive", "Invalid/Rejected/No Result")))
  table(demo_testing$result, demo_testing$result_num)
  table(demo_testing$result_fac, demo_testing$result_num)

	## recode dates
  ## uses resultsdate, unless missing, then uses labeldate
  demo_testing <- demo_testing %>%
                  mutate(testdate = ifelse(is.na(resultsdate), labeldate, resultsdate)) %>%
                  mutate(testdate = as.Date(testdate, origin="1970-01-01"))

  ## numeric laboratory indicator
  ## 0 "Sequoia"; 1 "Convenient MD"; 2 "Health & Wellness"; 3 "Pre-Arrival"; 4 "Quest"; 5 "Temp UNH Lab"
	table(tolower(demo_testing$laboratory))
  demo_testing <- demo_testing %>%
                  mutate(laboratory = tolower(laboratory)) %>%
                  mutate(laboratory_num = recode(laboratory,
                                             "sequoia" = 0,
                                             "cmd" = 1,
                                             "healthwellnesslab" = 2,
                                             "prearrival" = 3,
                                             "quest" = 4,
                                             "unhlab_temp" = 5)) %>%
                  mutate(laboratory_fac = factor(laboratory_num,
                                             levels = 0:5,
                                             labels = c("Sequoia", "Convenient MD", "Health + Wellness", "Pre-Arrival", "Quest", "UNH Temp.")))
  table(demo_testing$laboratory, demo_testing$laboratory_num)
  table(demo_testing$laboratory_fac, demo_testing$laboratory_num)
  
  ## binary test result indicators in long data - pos, neg, incon, invalid
  demo_testing <- demo_testing %>%
                  mutate(pos = ifelse(result_num == 1, 1, 0),
                         neg = ifelse(result_num == 0, 1, 0),
                         incon = ifelse(result_num == 2, 1, 0),
                         invalid = ifelse(result_num == 3, 1, 0))

  ## remove duplicate test results (labeldate, resultsdate, result, laboratory)
  demo_testing <- demo_testing %>%
                  distinct_at(vars(uid, testdate, result, laboratory), .keep_all = TRUE)

  ## make sure those positive once do not have positive counted more than once
    ## for each positive test result, check if there is another positive test result in the next 10 days
    ## QUESTION: repeat positives are currently dropped altogether
  demo_testing <- demo_testing %>%
                  mutate(posdate = ifelse(result_num==1, testdate, NA)) %>%
                  group_by(uid) %>%
                  arrange(desc(pos), testdate) %>%
                  fill(posdate) %>%
                  mutate(posdate_diff = c(-1, diff(posdate))) %>%
                  mutate(dup_pos = ifelse(result_num==1 & !is.na(posdate) & posdate_diff >= 0 & posdate_diff < 10, 1, 0)) %>%
                  ungroup() %>%
                  filter(dup_pos == 0)

  ## add epiweek
  ## add indicators for whether testdate is within 7 or 10 days of report date
  demo_testing <- demo_testing %>%
                  mutate(epiweek = epiweek(testdate),
                         test_10days = ifelse(testdate <= report_date & testdate > report_date_minus10, 1, 0),
                         test_7days = ifelse(testdate <= report_date & testdate > report_date_minus7, 1, 0))
  
  ## create data frame just of positive tests, without duplicates
  cases <- demo_testing %>% 
           filter(result_fac=="Positive")
  
```


```{r demo-testing-wide, include=params$run_checks}

  ## KYRA: I don't think we actually need this wide dataset? I think the summarized datasets below are more helpful

  ## by UID, add a sample number
  ## then make wide dataset by ID
  # demo_testing_wide <- demo_testing %>%
  #                      group_by(uid) %>%
  #                      mutate(sample_id = 1:n()) %>%
  #                      ungroup() %>%
  #                      select(uid, sample_id, testdate, result_fac, laboratory_fac) %>%
  #                      pivot_wider(id_cols = uid, names_from = sample_id, values_from = c(testdate, result_fac, laboratory_fac))


  ## print out max # of times someone was tested
  ## active case indicator: who had a positive test in the last 10 days report_date_minus10 - report_date
  ## 7-day case indicator
  ## tested in last 10 days indicator
  demo_testing_sum <- demo_testing %>%
                      group_by(uid) %>%
                      summarize(n_test = n(),
                                n_test_10day = sum(test_10days, na.rm=TRUE),
                                n_test_7days = sum(test_7days, na.rm=TRUE),
                                n_pos = sum(pos, na.rm=TRUE),
                                n_pos_10day = sum(pos*test_10days, na.rm=TRUE),
                                n_pos_7day = sum(pos*test_7days, na.rm=TRUE),
                                case_10day = ifelse(n_pos_10day>0, 1, 0),
                                case_7day = ifelse(n_pos_7day>0, 1, 0),
                                tested_10day = ifelse(n_test_10day>0, 1, 0),
                                tested_7day = ifelse(n_test_7days>0, 1, 0)) %>%
                      left_join(individualdemographics, by="uid")

  ## most recent lab result if tested in past week
    ## pull out most recent test result for anyone tested in last week
    ## (if there is more than one test on the last test date, use the positive)
    ## QUESTION: worth having this as an indicator in the long dataset?
  demo_testing_recent <- demo_testing %>%
                         filter(test_7days == 1) %>%
                         group_by(uid) %>%
                         arrange(desc(testdate), desc(pos)) %>%
                         slice(1)

```


```{r totals-by-date}

  ## data frame: number first positive by campus, role, testdate
  ts_cases_role <- cases %>%
                   group_by(testdate, campus_fac, user_status_fac) %>%
                   summarize(n = n()) %>%
                   ungroup()

  ## data frame: number first positive by campus status, campus, testdate
  ts_cases_offcamp <- cases %>%
                      group_by(testdate, campus_fac, off_campus_fac) %>%
                      summarize(n = n()) %>%
                      ungroup()

  ## data frame: number first positive by campus, testdate
  ts_cases_campus <- cases %>%
                     group_by(testdate, campus_fac) %>%
                     summarize(n = n()) 

  # data frame: active cases by day, by campus, by off/on campus for students only
  rollsum <- rollify(sum, window=7)
  ts_active_offcamp <- cases %>%
                       filter(user_status_fac=="Student") %>%
                       group_by(testdate, campus_fac, off_campus_fac) %>%
                       summarize(n = n()) %>%
                       ungroup() %>%
                       group_by(campus_fac, off_campus_fac) %>%
                       complete(testdate = as.Date(as.Date("2020-07-15"):report_date, origin="1970-01-01")) %>%
                       replace_na(list(n=0)) %>%
                       arrange(testdate) %>%
                       mutate(active_cases = rollsum(n)) %>%
                       ungroup()
  
  ## data frame: number pos, neg, incon, invalid, pos+neg, by campus, role, testdate
  ts_test_res <- demo_testing %>%
                 mutate(test = 1) %>%
                 group_by(testdate, campus_fac, user_status_fac) %>%
                 select(test, pos, neg, incon, invalid) %>%
                 summarise_all(sum) %>%
                 mutate(pos_neg = pos + neg,
                        pct_pos = pos / pos_neg) %>%
                 ungroup()
  
  ## data frame: number total tests, by campus, lab, testdate
  ts_test_lab <- demo_testing %>%
                 group_by(testdate, campus_fac, laboratory_fac) %>%
                 summarise(n_test = n(),
                           n_valid = n() - sum(invalid),
                           n_with_res = sum(neg) + sum(pos)) %>%
                 ungroup()
  
  ## data frame: number pos, neg, pos+neg by week
  ts_test_res_wk_all <- ts_test_res %>%
                        filter(testdate <= report_date) %>%
                        mutate(weeks_prior = as.numeric(report_date - testdate)%/%7) %>%
                        group_by(weeks_prior) %>%
                        summarise(pos = sum(pos),
                                  neg = sum(neg),
                                  pos_neg = pos + neg,
                                  pct_pos = pos / pos_neg) %>%
                        mutate(start_date = report_date - 7*weeks_prior,
                               end_date = report_date - 7*weeks_prior + 6,
                               label = glue("{format(start_date, '%b %d')} - {format(end_date, '%b %d')}"))

  ## data frame: number pos, neg, pos+neg by week, campus
  ts_test_res_wk_camp <-  ts_test_res %>%
                          filter(testdate <= report_date) %>%
                          mutate(weeks_prior = as.numeric(report_date - testdate)%/%7) %>%
                          group_by(weeks_prior, campus_fac) %>%
                          summarise(pos = sum(pos),
                                    neg = sum(neg),
                                    test = sum(test),
                                    pos_neg = pos + neg,
                                    pct_pos = pos / pos_neg) %>%
                          ungroup() %>%
                          mutate(start_date = report_date - 7*weeks_prior,
                                 end_date = report_date - 7*weeks_prior + 6,
                                 label = glue("{format(start_date, '%b %d')} - {format(end_date, '%b %d')}"))
  
  ## data frame: number pos, neg, pos+neg by week, campus, user_status
  ts_test_res_wk_role <- ts_test_res %>%
                         filter(testdate <= report_date) %>%
                         mutate(weeks_prior = as.numeric(report_date - testdate)%/%7) %>%
                         group_by(weeks_prior, campus_fac, user_status_fac) %>%
                         summarise(pos = sum(pos),
                                   neg = sum(neg),
                                   test = sum(test),
                                   pos_neg = pos + neg,
                                   pct_pos = pos / pos_neg) %>%
                         ungroup() %>%
                         mutate(start_date = report_date - 7*weeks_prior,
                                end_date = report_date - 7*weeks_prior + 6,
                                label = glue("{format(start_date, '%b %d')} - {format(end_date, '%b %d')}"))
  
  ## long versions of quarantine and isolation
  ## data frame: number in quarantine by campus, role, testdate
  ts_quar_role <- demo_quar_long %>%
                  group_by(date, campus_fac, user_status_fac) %>%
                  summarize(n = n_distinct(uid),
                            nbed = sum(quar_isol_bed, na.rm=TRUE)) %>%
                  ungroup() %>%
                  mutate(date = as.Date(date, origin="1970-01-01"))

  ## data frame: number in quarantine by location, campus, testdate
  ts_quar_offcamp <- demo_quar_long %>%
                     group_by(date, campus_fac, location) %>%
                     summarize(n = n_distinct(uid),
                               nbed = sum(quar_isol_bed, na.rm=TRUE)) %>%
                     ungroup() %>%
                     mutate(date = as.Date(date, origin="1970-01-01"))
  
  ## data frame: number in quarantine by campus, testdate
  ts_quar_campus <- demo_quar_long %>%
                    group_by(date, campus_fac) %>%
                    summarize(n = n_distinct(uid),
                              nbed = sum(quar_isol_bed, na.rm=TRUE)) %>%
                    ungroup() %>%
                    mutate(date = as.Date(date, origin="1970-01-01"))
  
  ## data frame: number in isolation by campus, role, testdate
  ts_isol_role <- demo_isol_long %>%
                  group_by(date, campus_fac, user_status_fac) %>%
                  summarize(n = n_distinct(uid),
                            nbed = sum(quar_isol_bed, na.rm=TRUE)) %>%
                  ungroup() %>%
                  mutate(date = as.Date(date, origin="1970-01-01"))

  ## data frame: number in isolation by location, campus, testdate
  ts_isol_offcamp <- demo_isol_long %>%
                     group_by(date, campus_fac, location) %>%
                     summarize(n = n_distinct(uid),
                               nbed = sum(quar_isol_bed, na.rm=TRUE)) %>%
                     ungroup() %>%
                     mutate(date = as.Date(date, origin="1970-01-01"))

  ## data frame: number in isolation by campus, testdate
  ts_isol_campus <- demo_isol_long %>%
                    group_by(date, campus_fac) %>%
                    summarize(n = n_distinct(uid),
                              nbed = sum(quar_isol_bed, na.rm=TRUE)) %>%
                    ungroup() %>%
                    mutate(date = as.Date(date, origin="1970-01-01"))
  

```

```{r map loading}
  box = c(xmin = 1177000 , xmax = 1183000 ,ymin=229500,ymax=237000 )
  
  BaseMap <- read_sf("shapefiles/UNH_Basemap.shp") 
  Buildings <- read_sf("shapefiles/UNH_Buildings.shp")%>%
                  st_crop(box)
  
  sidewalks <- filter(BaseMap,LAND_USE=="Sidewalk")%>%
                  st_make_valid()%>%
                  st_crop(box)
  greenspace <- filter(BaseMap,LAND_USE=="Green Space")%>%
                  st_make_valid()%>%
                  st_crop(box)
```

## `r glue("UNH SURVEILLANCE REPORT: {report_date}")`

Start: `r start_date_str_long`

End: `r report_date_str_long`

Data reported as of: `r format(Sys.Date(), "%B %d, %Y")`

-----------------------------------------

## SECTION A: EXECUTIVE SUMMARY

**Overall**

* In the state of New Hampshire, current cases and hospitalizations have increased. The number of current cases (1,903) has shifted operational level from orange to red and the number of hospitalizations (55) has shifted operational level from yellow to orange.

* In the UNH community, the number of new positive tests rose from last week (61 this vs. 35 last people with new positive results, per complete data)

* Number in quarantine and isolation is trending upwards compared with previous weeks

**At the Durham campus:**

* Cases among students continue to increase

* 32/42 new student cases did not have a dorm listed (likely live off campus). Student cases are more commonly 20+ years old (30/42) and female (32/42). The highest number of cases was reported among students in the health college.

* The percent positive (out of all positive & negative tests) is increasing (see Figure B.3) and is is comparable to the positivity early in the semester (August)

* There was a rise in tests with invalid results compared to last week

* Based on current isolation beds in use, the campus remains at the yellow trigger level
(44.1% of isolation beds are in use this week), but is getting close to the red trigger level.

* If the number of new cases remain at this weekâ€™s rate, we project that isolation beds will
be close to overwhelmed.

**At the Concord Law campus:**

* No new cases reported this week

**At the Manchester campus:**

* One new case was reported this week.


-----------------------------------------

## SECTION B: UNIVERSITY-WIDE SITUATION


-----------------------------------------

### Statewide Conditions

```{r Table-B1A-StateCond}

  ## parse state page for current COVID19 cases, hospitalizations
  ## operation levels with colors
  statecondurl <- "https://www.nh.gov/covid19/index.htm"
  statecondwebsite <- read_html(statecondurl)

  # get state current cases and current hospitalizations
  covid_num <- statecondwebsite %>%
    html_nodes("td") %>%
    html_text()

  state_curr_cases <- as.numeric(gsub(",", "", covid_num[4]))
  state_curr_hosp <- as.numeric(gsub(",", "", covid_num[6]))
  state_curr_cond <- params$state_conditions

  statedatetimeupdated <- statecondwebsite %>%
    html_nodes("h4") %>%
    html_text()
  
  state_tab <- data.frame(var = c("Current COVID-19 cases",
                                  "Current COVID-19 hospitalizations",
                                  "Most strict restrictions"),
                          val = c(state_curr_cases, state_curr_hosp, state_curr_cond),
                          level = c(pick_color_threshold_str(state_curr_cases, thresholds=c(0, 100, 1200, 1800)),
                                    pick_color_threshold_str(state_curr_hosp, thresholds = c(0, 25, 50, 100)),
                                    "www.nh.gov/covid19"))
  
  cell_cols <- c(pick_color_threshold(state_curr_cases, thresholds=c(0, 100, 1200, 1800)),
                 pick_color_threshold(state_curr_hosp, thresholds = c(0, 25, 50, 100)),
                 "#FFFFFF")
  state_tab %>%
    flextable() %>%
    set_header_labels(var = "",
                      val = "This Week",
                      level = "Operational Level") %>%
    bg(j=3, bg = cell_cols) %>%
    autofit() %>%
    add_footer_lines(values = glue("{statedatetimeupdated}"))

                          
  
```

-----------------------------------------

### Conditions at Three Campuses

```{r Table-B1B-CampusCond}

  # BY CAMPUS + THRESHOLD INDICATOR if applicable
    # Total tests, including repeats
    # Tests per unique ID
    # total positive test results
    # total active cases from last 10 days
    # active cases per 1000 tested
    # average in isolation over last week
    # average isolation beds in use
    # average number in quarantine this week
    # average quarantine beds in use

  cap <- glue("Table {tab_counter}. Key indicators at each campus.")
  tab_counter <- tab_counter + 1
 
  testingpop <- individualdemographics %>% 
                group_by(campus_fac) %>%
                summarise(pop=n())

  # get test campus conditions indicators together
  testdf <- ts_test_res %>% 
            filter(testdate>as.Date(report_date_minus7)) %>%
            filter(testdate<=as.Date(report_date)) %>%
            group_by(campus_fac,.drop=FALSE) %>%
            summarize(totaltests=sum(test,na.rm=TRUE),
                      totalpositives=sum(pos,na.rm=TRUE)
                      ) %>%
            left_join(testingpop,by="campus_fac")%>%
            mutate(testperID=round(totaltests/pop,1)) %>%
            select(-pop)

  # get the pct post indicators together
  posdf <- ts_test_res_wk_camp %>%
           filter(weeks_prior==0) %>%
           mutate(pct_pos_label = glue("{round(pct_pos*100, 1)}%")) %>%
           select(campus_fac, pct_pos, pct_pos_label)
  
  # get case campus conditions indicators together
  casedf <- ts_cases_campus %>% 
            filter(testdate>as.Date(report_date_minus10)) %>%
            filter(testdate<=as.Date(report_date)) %>%
            group_by(campus_fac,.drop=FALSE) %>%
            summarize(activeCases=sum(n,na.rm=TRUE)) %>%
            left_join(testingpop,by="campus_fac")%>%
            mutate(activeCaseRate=round(activeCases/pop*1000,1))%>%
            select(-pop)

  # isolation indicators
  isoldf <- ts_isol_campus %>%
            filter(date>as.Date(report_date_minus7)) %>%
            filter(date<=as.Date(report_date)) %>%
            group_by(campus_fac,.drop=FALSE) %>%
            summarize(NAvgIsol = mean(n, na.rm=TRUE),
                      NAvgIsolBed = mean(nbed, na.rm=TRUE)) %>%
            replace_na(list(NAvgIsol = 0,
                            NAvgIsolBed = 0)) %>%
            mutate(NAvgIsolBedPct = NAvgIsolBed / 59) %>%
            mutate(NAvgIsol = round(NAvgIsol, 1)) %>%
            mutate(NAvgIsolBedLabel = ifelse(campus_fac=="UNH Durham", 
                                             glue("{round(NAvgIsolBed, 1)} ({round(NAvgIsolBedPct*100, 1)}%)"),
                                             "-")) %>%
            select(campus_fac, NAvgIsol, NAvgIsolBedPct, NAvgIsolBedLabel)

  # quarantine indicators
  quardf <- ts_quar_campus %>%
            filter(date>as.Date(report_date_minus7)) %>%
            filter(date<=as.Date(report_date)) %>%
            group_by(campus_fac,.drop=FALSE) %>%
            summarize(NAvgQuar = mean(n, na.rm=TRUE),
                      NAvgQuarBed = mean(nbed, na.rm=TRUE)) %>%
            replace_na(list(NAvgQuar = 0,
                            NAvgQuarBed = 0)) %>%
            mutate(NAvgQuarBedPct = NAvgQuarBed / 180) %>%
            mutate(NAvgQuar = round(NAvgQuar, 1)) %>%
            mutate(NAvgQuarBedLabel = ifelse(campus_fac=="UNH Durham",
                                             glue("{round(NAvgQuarBed, 1)} ({round(NAvgQuarBedPct*100, 1)}%)"),
                                             "-")) %>%
            select(campus_fac, NAvgQuar, NAvgQuarBedPct, NAvgQuarBedLabel)
  
  # bring all indicators together
  indicatordf <-  left_join(testdf,casedf,by="campus_fac")  %>%
                  left_join(posdf %>% select(-pct_pos), by="campus_fac") %>%
                  left_join(isoldf %>% select(-NAvgIsolBedPct), by="campus_fac") %>%
                  left_join(quardf %>% select(-NAvgQuarBedPct), by="campus_fac") %>%
                  filter(!(campus_fac %in% c("Other","Missing"))) %>%
                  # switch the campus from rows to columns
                  gather(Indicator,value,-campus_fac) %>%
                  spread(campus_fac,value) %>%
                  # make character vectors for rounding purposes
                  mutate(`UNH Durham`=as.character(`UNH Durham`))%>%
                  mutate(`UNH Law`=as.character(`UNH Law`))%>%
                  mutate(`UNH Manchester`=as.character(`UNH Manchester`))%>%
                  #need to adjust indicator names and put in order
                  mutate(Indicator=recode_factor(Indicator,
                                          "totaltests"= "Number of tests",
                                          "testperID" = "Tests per unique ID",
                                          "totalpositives"="Total Positive Test Results",
                                          "pct_pos_label"="Percent Positive (7d average)",
                                          "activeCases"="Active Cases",
                                          "activeCaseRate"="Active Cases per 1000",
                                          "NAvgIsol" = "Average number in isolation this week",
                                          "NAvgIsolBedLabel" = "Average isolation beds in use (n, %)",
                                          "NAvgQuar" = "Average number in quarantine this week",
                                          "NAvgQuarBedLabel" = "Average quarantine beds in use (n, %)"
                                          ))%>%
                  arrange(Indicator) 

  active_case_colors <- indicatordf %>%
                        filter(Indicator == "Active Cases") %>%
                        select(-Indicator) %>%
                        mutate_all(function(x){pick_color_threshold(as.numeric(x), thresholds=c(-1, 20, 100, 200))}) %>%
                        unlist()
  
  pct_pos_colors <- posdf %>%
                    filter(!(campus_fac %in% c("Other","Missing"))) %>%
                    arrange(campus_fac) %>%
                    select(pct_pos) %>%
                    mutate_all(function(x){pick_color_threshold(as.numeric(x), thresholds=c(-1, 0.0025, 0.01, 0.07))}) %>%
                    unlist()
    
  isol_bed_colors <- c(pick_color_threshold(isoldf$NAvgIsolBedPct[isoldf$campus_fac=="UNH Durham"], thresholds=c(-1, 0.1, 0.5, 0.9)),
                       "#FFFFFF",
                       "#FFFFFF")
  
  quar_bed_colors <- c(pick_color_threshold(quardf$NAvgQuarBedPct[quardf$campus_fac=="UNH Durham"], thresholds=c(-1, 0.25, 0.5, 0.9)),
                       "#FFFFFF",
                       "#FFFFFF")
  
  # make flextable
  indicatordf %>% 
    flextable() %>%
    autofit() %>%
    bold(i=1, part="header") %>%
    set_header_labels(Indicator="") %>%
    set_caption(caption = cap) %>%
    bg(i=~(Indicator == "Active Cases"), j=2:4, bg = active_case_colors) %>%
    bg(i=~(Indicator == "Percent Positive (7d average)"), j=2:4, bg = pct_pos_colors) %>%
    bg(i=~(Indicator == "Average isolation beds in use (n, %)"), j=2:4, bg = isol_bed_colors) %>%
    bg(i=~(Indicator == "Average quarantine beds in use (n, %)"), j=2:4, bg = quar_bed_colors) 

```

-----------------------------------------

### Confirmed Cases and Testing Results

```{r Figure-B1-EpiCurve, fig.cap = cap}

  ## epi curve, new positive, all time, by day, colored by campus
  ggplot(ts_cases_campus, aes(x=testdate, y=n, fill=campus_fac)) +
    geom_col(width=0.9)+
    theme_bw()+
    scale_fill_brewer("Campus",type = "qual") +
    scale_y_continuous(name = "Cases", breaks=breaks_pretty()) +
    scale_x_date(name="", date_breaks = "2 weeks", limits = xaxis_entire) +
    theme(legend.position = "bottom", legend.title = element_blank())
      
  cap <- glue("**Figure B{fig_counter}**. Newly reported positive cases, by testing date, in each campus.")
  fig_counter <- fig_counter + 1
  
```


```{r Figure-B2-EpiCurve-7day, fig.cap = cap}

  ggplot(ts_cases_campus %>% filter(testdate <= report_date, testdate > report_date_minus7), aes(x=testdate, y=n, fill=campus_fac)) +
    geom_col(width=0.9)+
    theme_bw()+
    scale_fill_brewer("Campus",type = "qual") +
    scale_y_continuous(name = "Cases", breaks=breaks_pretty()) +
    scale_x_date(name="", breaks = seq(report_date_minus7, report_date, 1), limits = xaxis_reporting) +
    theme(legend.position = "bottom", legend.title = element_blank())
      
  cap <- glue("**Figure B{fig_counter}**. Newly reported positive cases, by testing date, in each campus for the reporting period. Any campus not displayed had no reported positive cases in this period.")
  fig_counter <- fig_counter + 1

```


```{r Table-B3-TestSubmitted}
  
  ## all campuses combined, by role in last week:
  ## all campuses combined, cumulative in last week and all time:
    # total tests submitted
    # unique IDs submitting (as prop of all IDs not previously positive)
    # tests per unique ID
  
  cap <- glue("Table B{tab_counter}. Tests submitted including repeats at all UNH campuses.")
  tab_counter <- tab_counter + 1 
  
  ntest_rep <- ts_test_res %>%
               filter(testdate > report_date_minus7 & testdate <= report_date) %>%
               group_by(user_status_fac) %>%
               summarise(n_tests = sum(test)) %>%
               rename(label = user_status_fac)
  ntest_total <- ts_test_res %>%
                 filter(testdate > report_date_minus7 & testdate <= report_date) %>%
                 summarise(n_tests = sum(test)) %>%
                 mutate(label = "Total (reporting week)")
  ntest_cum <- ts_test_res %>%
               summarise(n_tests = sum(test)) %>%
               mutate(label = "Cumulative (all time)")
  ntest <- bind_rows(ntest_rep, ntest_total, ntest_cum)
  
  nid_rep <- demo_testing_sum %>%
             group_by(user_status_fac) %>%
             summarise(n_id = sum(tested_7day)) %>%
             rename(label = user_status_fac)
  nid_total <- demo_testing_sum %>%
               summarise(n_id = sum(tested_7day)) %>%
               mutate(label = "Total (reporting week)")
  nid_cum <- demo_testing_sum %>%
             summarise(n_id = sum(n_test>0, na.rm=TRUE)) %>%
             mutate(label = "Cumulative (all time)")
  nid <- bind_rows(nid_rep, nid_total, nid_cum)
  
  tab_b3 <- left_join(ntest, nid) %>%
            mutate(n_test_per_id = round(n_tests / n_id, 2)) %>%
            mutate(label = ifelse(label=="Unknown", "Contractors and Visitors", label)) %>%
            rename(`Total Tests Submitted` = n_tests,
                   `Unique IDs Submitting` = n_id,
                   `Tests Submitted per ID` = n_test_per_id,
                   ` ` = label)
  
  tab_b3 %>% 
    flextable() %>%
    autofit() %>%
    hline(i=4, part="body", border=fp_border(width=2)) %>%
    bold(i=1, part="header") %>%
    bold(j=1) %>%
    add_footer_lines(values="All values presented for the current reporting week, unless otherwise noted.") %>%
    set_caption(caption = cap)

  
```


```{r Table-B4-MostRecentLab}

  ## all campuses combined, by role + total:
    # most recent result positive, neg, incon, invalid
  
  cap <- glue("Table B{tab_counter}. Most recent lab result for each individual submitting a sample in the reporting period at all UNH campuses.")
  tab_counter <- tab_counter + 1 
  
  recent_rep <- demo_testing_recent %>%
                ungroup() %>%
                group_by(user_status_fac) %>%
                select(pos, neg, incon, invalid) %>%
                summarise_all(sum)

  recent_total <- demo_testing_recent %>%
                  ungroup() %>%
                  select(pos, neg, incon, invalid) %>%
                  summarise_all(sum) %>%
                  mutate(user_status_fac = "Total (reporting week)")
  
  tab_b4 <- bind_rows(recent_rep, recent_total) %>%
            mutate(user_status_fac = ifelse(user_status_fac=="Unknown", "Contractors and Visitors", user_status_fac)) %>%
            rename(`Positive` = pos,
                   `Negative` = neg,
                   `Inconclusive` = incon,
                   `Invalid` = invalid,
                   ` ` = user_status_fac)

  tab_b4 %>%
    flextable() %>%
    autofit() %>%
    hline(i=4, part="body", border=fp_border(width=2)) %>%
    bold(i=1, part="header") %>%
    bold(j=1) %>%
    set_caption(caption = cap)

  
```


```{r Figure-B3-PropPositive, fig.cap = cap}

  ## TO DO: make labels the week period. This is annoying :(

  ## by week, # pos / (# pos + # neg)

  rng <- ceiling(max(ts_test_res_wk_all$pct_pos, na.rm = TRUE)*1000)/1000
  brks <- seq(0, rng, 0.0005)
  xbrks <- ts_test_res_wk_all$start_date
  xlab <- ts_test_res_wk_all$label
  
  ggplot(ts_test_res_wk_all, aes(x=start_date, y=pct_pos)) +
    geom_line(color = "#120075", size=1.25) +
    scale_y_continuous(name="Percent Positive", breaks=brks, labels=glue("{brks*100}%")) +
    scale_x_date(name="", breaks=xbrks, labels=xlab) +
    theme_bw() +
    theme(axis.text.x = element_text(angle=45, vjust = 1, hjust=1))

    
  cap <- glue("**Figure B{fig_counter}**. Proportion of positive tests over all negative and positive tests.")
  fig_counter <- fig_counter + 1
  
```
		
-----------------------------------------

### Quarantine and Isolation Across Campuses

```{r Figure-B4-Quar-7day, fig.cap=cap}

  ts_quar_role_sum <- ts_quar_role %>% select(-campus_fac) %>% group_by(date, user_status_fac) %>% summarise_all(sum)

  ## number in quarantine, by role. by day, last 7 days
  ggplot(ts_quar_role_sum %>% filter(date <= report_date, date > report_date_minus7), aes(x=date, y=n, fill=user_status_fac)) +
    geom_col()+
    theme_bw()+
    scale_fill_brewer("",type = "qual") +
    scale_y_continuous(name = "", breaks=breaks_pretty()) +
    scale_x_date(name="", date_breaks = "1 day", limits = xaxis_reporting) +
    theme(legend.position = "bottom", legend.title = element_blank())
      
  cap <- glue("**Figure B{fig_counter}**. Number in quarantine by day, by role, for the reporting week.")
  fig_counter <- fig_counter + 1
  
```


```{r Figure-B5-Quar, fig.cap=cap}

  ## number in quarantine, by role. by day, all time
  ggplot(ts_quar_role_sum, aes(x=date, y=n, fill=user_status_fac)) +
    geom_col()+
    theme_bw()+
    scale_fill_brewer("",type = "qual") +
    scale_y_continuous(name = "", breaks=breaks_pretty()) +
    scale_x_date(name="", breaks="2 weeks", limits = xaxis_entire) +
    theme(legend.position = "bottom", legend.title = element_blank())
      
  cap <- glue("**Figure B{fig_counter}**. Number in quarantine by day, by role, for the entire reporting period.")
  fig_counter <- fig_counter + 1
  
```


```{r Figure-B6-Isol-7day, fig.cap=cap}

  ## number in isolation, by role, by day, last 7 days
  ts_isol_role_sum <- ts_isol_role %>% select(-campus_fac) %>% group_by(date, user_status_fac) %>% summarise_all(sum)

  ggplot(ts_isol_role_sum %>% filter(date <= report_date, date > report_date_minus7), aes(x=date, y=n, fill=user_status_fac)) +
    geom_col()+
    theme_bw()+
    scale_fill_brewer("",type = "qual") +
    scale_y_continuous(name = "", breaks=breaks_pretty()) +
    scale_x_date(name="", breaks="1 day", limits = xaxis_reporting) +
    theme(legend.position = "bottom", legend.title = element_blank())
      
  cap <- glue("**Figure B{fig_counter}**. Number in isolation by day, by role, for the reporting week.")
  fig_counter <- fig_counter + 1
  
```


```{r Figure-B7-Isol, fig.cap=cap}
  
  ## number in isolation, by role, by day, all time
  ggplot(ts_isol_role_sum, aes(x=date, y=n, fill=user_status_fac)) +
    geom_col()+
    theme_bw()+
    scale_fill_brewer("",type = "qual") +
    scale_y_continuous(name = "", breaks=breaks_pretty()) +
    scale_x_date(name="", breaks="2 weeks", limits = xaxis_entire) +
    theme(legend.position = "bottom", legend.title = element_blank())
      
  cap <- glue("**Figure B{fig_counter}**. Number in isolation by day, by role, for the entire reporting period.")
  fig_counter <- fig_counter + 1
  
```


-----------------------------------------

## SECTION C: DURHAM CAMPUS

```{r start-Durham}
  fig_counter <- 1
  tab_counter <- 1
```

```{r Table-C1-DurhamCond}

  # This Week value + Threshold Indicator, if applicable
    # total active cases from last 10 days
    # active cases per 1000 tested
    # average in isolation over last week
    # average isolation beds in use
    # average number in quarantine this week
    # average quarantine beds in use

    cap <- glue("Table C{tab_counter}. Durham Campus Operating Conditions.")
    tab_counter <- tab_counter + 1 
  
    indicatordf %>% 
    select(Indicator, `UNH Durham`) %>%
    filter(Indicator %in% c("Active Cases", "Active Cases per 1000", "Average number in isolation this week", "Average isolation beds in use (n, %)", "Average number in quarantine this week", "Average quarantine beds in use (n, %)", "Percent Positive (7d average)")) %>%
    flextable() %>%
    bold(i=1, part="header") %>%
    set_header_labels(Indicator="",
                      `UNH Durham`="Reporting Period") %>%
    autofit() %>%
    set_caption(caption = cap) %>%
    bg(i=~(Indicator == "Active Cases"), j=2, bg = active_case_colors[1]) %>%
    bg(i=~(Indicator == "Percent Positive (7d average)"), j=2, bg = pct_pos_colors[1]) %>%
    bg(i=~(Indicator == "Average isolation beds in use (n, %)"), j=2, bg = isol_bed_colors[1]) %>%
    bg(i=~(Indicator == "Average quarantine beds in use (n, %)"), j=2, bg = quar_bed_colors[1]) 

```

-----------------------------------------

### Confirmed Cases and Testing Results

```{r Figure-C1-EpiCurve, fig.cap=cap}

  ## epi curve, new positive, all time, by day, colored by role
  ggplot(ts_cases_role %>% filter(campus_fac == "UNH Durham"), aes(x=testdate, y=n, fill=user_status_fac)) +
    geom_col(width=0.9)+
    theme_bw()+
    scale_fill_brewer("Campus",type = "qual") +
    scale_y_continuous(name = "Cases", breaks=breaks_pretty()) +
    scale_x_date(name="", breaks="2 weeks", limits = xaxis_entire) +
    theme(legend.position = "bottom", legend.title = element_blank())
      
  cap <- glue("**Figure C{fig_counter}**. Newly reported positive cases, by testing date, in UNH Durham.")
  fig_counter <- fig_counter + 1
  
```


```{r Figure-C2-EpiCurve-7day, fig.cap=cap}

  ## epi curve, new positive, last 7 days, by day, colored by role
  ggplot(ts_cases_role %>% filter(campus_fac == "UNH Durham" & testdate <= report_date & testdate > report_date_minus7), aes(x=testdate, y=n, fill=user_status_fac)) +
    geom_col(width=0.9)+
    theme_bw()+
    scale_fill_brewer("Campus",type = "qual") +
    scale_y_continuous(name = "Cases", breaks=breaks_pretty()) +
    scale_x_date(name="", breaks="1 day", limits = xaxis_reporting) +
    theme(legend.position = "bottom", legend.title = element_blank())
      
  cap <- glue("**Figure C{fig_counter}**. Newly reported positive cases, by testing date, in UNH Durham for reporting week.")
  fig_counter <- fig_counter + 1
  
```


```{r Figure-C3-TestSubmitted, fig.cap=cap}
  
  xbrks <- ts_test_res_wk_all$start_date[seq(1, max(ts_test_res_wk_all$weeks_prior), 2)]
  xlab <- ts_test_res_wk_all$label[seq(1, max(ts_test_res_wk_all$weeks_prior), 2)]
  
  ## by week, total tests submitted (including repeats), colored by role
  ggplot(ts_test_res_wk_role %>% filter(campus_fac=="UNH Durham"), aes(x=start_date, y=test)) +
    geom_line(color = "#120075", size=1.25) +
    scale_x_date(name="", breaks=xbrks, labels=xlab) +
    facet_wrap(.~user_status_fac, scales="free_y") +
    theme_bw() +
    theme(axis.text.x = element_text(angle=45, vjust = 1, hjust=1))

  
  cap <- glue("**Figure C{fig_counter}**. Total tests submitted per week in UNH Durham. Note the different y-axis scales.")
  fig_counter <- fig_counter + 1
  
```


```{r Figure-C4A-PropPositive, fig.cap=cap}

  ## by week, # pos / (# pos + # neg)
  rng <- ceiling(max(ts_test_res_wk_camp$pct_pos[ts_test_res_wk_camp$campus_fac=="UNH Durham"], na.rm = TRUE)*1000)/1000
  brks <- seq(0, rng, 0.0005)
  xbrks <- ts_test_res_wk_all$start_date
  xlab <- ts_test_res_wk_all$label
  
  ggplot(ts_test_res_wk_camp %>% filter(campus_fac == "UNH Durham"), aes(x=start_date, y=pct_pos)) +
    geom_line(color = "#120075", size=1.25) +
    scale_y_continuous(name="Percent Positive", breaks=brks, labels=glue("{brks*100}%")) +
    scale_x_date(name="", breaks=xbrks, labels=xlab) +
    theme_bw() +
    theme(axis.text.x = element_text(angle=45, vjust = 1, hjust=1))

    
  cap <- glue("**Figure C{fig_counter}**. Proportion of positive tests over all negative and positive tests in UNH Durham.")
  fig_counter <- fig_counter + 1
  
```


```{r Figure-C4-Map-Active-and-Cumulative, fig.cap=cap}

  Allcases <- cases %>%
              left_join(read_csv("generated_data/linkingfile.csv")) %>%
              group_by(BUILDING_N) %>%
              summarise(cases=n()) 

  cases10 <- cases %>% 
             filter(testdate>report_date_minus10 & testdate<=report_date)%>%
             left_join(read_csv("generated_data/linkingfile.csv")) %>%
             group_by(BUILDING_N) %>%
             summarise(cases=n())


  dormlist <- demo_testing %>% 
              filter(!is.na(dorm)) %>%
              distinct(dorm) %>%
              left_join(read_csv("generated_data/linkingfile.csv")) %>%
              select(-FACILITIES)

  dormdf <- filter(Buildings,BUILDING_N %in% dormlist$BUILDING_N) %>%
            mutate(centroid=st_centroid(geometry))%>%
            mutate(centerx=NA,centery=NA)

  for (i in seq_len(nrow(dormdf))){
          
          dormdf$centerx[i] <- dormdf$centroid[[i]][[1]]
          dormdf$centery[i] <- dormdf$centroid[[i]][[2]]
          
  }

  to_add <- bind_rows(Allcases %>%  mutate(map = "Cumulative Cases"),
                      cases10 %>% mutate(map = "Active Cases (last 10 days)"))
  dormdf <- left_join(dormdf, to_add)
  
  dormlabels <-  data.frame(
          names=c("The Gables", "Woodside","The Hills",
                  "The Valley", "The Timbers"),
          
          x=c(0.55,0.65,0.8,0.85,0.35)*(box[2]-box[1])+box[1],
          y=c(0.8,0.7,0.55,0.25,0.35)*(box[4]-box[3])+box[3]
  )


  #function to adjust size of cases (may want to use later)
  calc_radius <- function(n, scale_factor = 30) {
    sqrt(n)/sqrt(max(n,na.rm = TRUE)) * scale_factor
  }

  dormdf %>% 
    mutate(caseSize=calc_radius(cases)) %>% 
    filter(!is.na(map)) %>%
    ggplot() +
    geom_sf(col=NA,fill="black")+
    geom_sf(data=greenspace,fill="lightblue",col=NA)+
    geom_point(aes(size=cases,x=centerx,y=centery),
               color="darkred",fill="red",alpha=0.8,pch=21)+
    geom_text(data=dormlabels,aes(x=x,y=y,label=names))+
    scale_size(limits=c(1,max(c(20,dormdf$cases),na.rm = TRUE)),breaks=c(1,10,20))+
    theme_void()+
    facet_wrap(.~map,nrow=1)

  cap <- glue("**Figure C{fig_counter}**. Active (tested positive in 10 days prior to report end date) and cumulative (tested positive any time prior to report end date) cases by resident dorm among students living on-campus at UNH Durham.")
  fig_counter <- fig_counter + 1
  
```


```{r Table-C2-OnOffCampus}

  # average number daily active cases among students, by dorm vs no dorm
    # current week
    # last week
    # % change
    # sparkline % change all time
  
  cap <- glue("Table C{tab_counter}. Average number of daily 'Active Cases' among students at UNH Durham in the reporting period and in the week prior.")
  tab_counter <- tab_counter+1
  
  tab_c2 <- ts_active_offcamp %>%
            filter(campus_fac == "UNH Durham") %>%
            filter(testdate > report_date_minus14 & testdate<=report_date) %>%
            mutate(week = ifelse(testdate > report_date_minus7, "Current", "Previous")) %>%
            group_by(week, off_campus_fac) %>%
            summarise(n_active = mean(active_cases)) %>%
            pivot_wider(names_from = week, values_from = n_active) %>%
            mutate(pct_change = ifelse(Previous>0,
                                       glue("{round((Current - Previous)/Previous*100, 2)}%"),
                                       "-")) %>%
           mutate(Previous = round(Previous, 2),
                  Current = round(Current, 2),
                  off_campus_fac = recode(off_campus_fac,
                                   "On Campus" = "Dorm Listed",
                                   "Off Campus" = "Dorm Not Listed"))
            
  tab_c2 %>%
    select(off_campus_fac, Previous, Current, pct_change) %>%
    flextable() %>%
    set_header_labels(off_campus_fac = "",
                      Current = glue("Reporting period \nending {report_date_str_short}"),
                      Previous = glue("Reporting period \nending {report_date_minus7_str_short}"),
                      pct_change = "% Change") %>%
    autofit() %>%
    bold(i=1, part="header") %>%
    bold(j=1) %>%
    set_caption(caption = cap)

```


```{r Table-C3-MostRecentLab}

  cap <- glue("Table C{tab_counter}. Most recent lab result for each individual submitting a sample in the reporting period at UNH Durham.")
  tab_counter <- tab_counter + 1 
  
  ## by role + total, last seven days: most recent result positive, neg, incon, invalid
  recent_rep_dur <- demo_testing_recent %>%
                    filter(campus_fac == "UNH Durham") %>%
                    ungroup() %>%
                    group_by(user_status_fac, .drop = FALSE) %>%
                    select(pos, neg, incon, invalid) %>%
                    summarise_all(sum)

  recent_total_dur <- demo_testing_recent %>%
                      filter(campus_fac == "UNH Durham") %>%
                      ungroup() %>%
                      select(pos, neg, incon, invalid) %>%
                      summarise_all(sum) %>%
                      mutate(user_status_fac = "Total (reporting week)")
  
  tab_c3 <- bind_rows(recent_rep_dur, recent_total_dur) %>%
            filter(user_status_fac != "Employee") %>%
            mutate(user_status_fac = ifelse(user_status_fac=="Unknown", "Contractors and Visitors", user_status_fac)) %>%
            rename(`Positive` = pos,
                   `Negative` = neg,
                   `Inconclusive` = incon,
                   `Invalid` = invalid,
                   ` ` = user_status_fac)

  tab_c3 %>%
    flextable() %>%
    autofit() %>%
    hline(i=4, part="body", border=fp_border(width=2)) %>%
    bold(i=1, part="header") %>%
    bold(j=1) %>%
    set_caption(caption = cap)
  
```


```{r Table-C4-TestSubmitted}
  
  ## by role in last week, cumulative in last week and all time:
    # total tests submitted
    # unique IDs submitting (as prop of all IDs not previously positive)
    # tests per unique ID
  
  cap <- glue("Table C{tab_counter}. Tests submitted including repeats at UNH Durham.")
  tab_counter <- tab_counter + 1 
  
  ntest_rep <- ts_test_res %>%
               filter(campus_fac == "UNH Durham") %>%
               filter(testdate > report_date_minus7 & testdate <= report_date) %>%
               group_by(user_status_fac, .drop = FALSE) %>%
               summarise(n_tests = sum(test)) %>%
               rename(label = user_status_fac)
  ntest_total <- ts_test_res %>%
                 filter(campus_fac == "UNH Durham") %>%
                 filter(testdate > report_date_minus7 & testdate <= report_date) %>%
                 summarise(n_tests = sum(test)) %>%
                 mutate(label = "Total (reporting week)")
  ntest_cum <- ts_test_res %>%
               filter(campus_fac == "UNH Durham") %>%
               summarise(n_tests = sum(test)) %>%
               mutate(label = "Cumulative (all time)")
  ntest <- bind_rows(ntest_rep, ntest_total, ntest_cum)
  
  nid_rep <- demo_testing_sum %>%
             filter(campus_fac == "UNH Durham") %>%
             group_by(user_status_fac, .drop = FALSE) %>%
             summarise(n_id = sum(tested_7day)) %>%
             rename(label = user_status_fac)
  nid_total <- demo_testing_sum %>%
               filter(campus_fac == "UNH Durham") %>%
               summarise(n_id = sum(tested_7day)) %>%
               mutate(label = "Total (reporting week)")
  nid_cum <- demo_testing_sum %>%
             filter(campus_fac == "UNH Durham") %>%
             summarise(n_id = sum(n_test>0, na.rm=TRUE)) %>%
             mutate(label = "Cumulative (all time)")
  nid <- bind_rows(nid_rep, nid_total, nid_cum)
  
  tab_c4 <- left_join(ntest, nid) %>%
            mutate(n_test_per_id = round(n_tests / n_id, 2)) %>%
            mutate(label = ifelse(label=="Unknown", "Contractors and Visitors", label)) %>%
            filter(label != "Employee") %>%
            rename(`Total Tests Submitted` = n_tests,
                   `Unique IDs Submitting` = n_id,
                   `Tests Submitted per ID` = n_test_per_id,
                   ` ` = label)
  
  tab_c4 %>% 
    flextable() %>%
    autofit() %>%
    hline(i=4, part="body", border=fp_border(width=2)) %>%
    bold(i=1, part="header") %>%
    bold(j=1) %>%
    add_footer_lines(values="All values presented for the current reporting week, unless otherwise noted.") %>%
    set_caption(caption = cap)
  
```


```{r Table-C5-Lab}

  cap <- glue("Table C{tab_counter}. Laboratory operations (as number of tests returned with results and percent of all tests submitted) at UNH Durham in the reporting period and in the week prior.")
  tab_counter <- tab_counter+1
  
  # total number tests submitted by lab, last week + current week, sparkline weekly average over time
  tab_c5 <- ts_test_lab %>%
            filter(campus_fac == "UNH Durham") %>%
            filter(testdate > report_date_minus14 & testdate<=report_date) %>%
            mutate(week = ifelse(testdate > report_date_minus7, "Current", "Previous")) %>%
            group_by(week, laboratory_fac) %>%
            summarise(n_test = sum(n_test),
                      n_res = sum(n_with_res),
                      pct_res = round(n_res/n_test*100, 1),
                      val = glue("{n_res} ({pct_res}%)")) %>%
            select(-n_test, -pct_res) %>%
            pivot_wider(names_from = week, values_from = c(val, n_res)) %>%
            mutate(pct_change = ifelse(n_res_Previous>0,
                                       glue("{round((n_res_Current - n_res_Previous)/n_res_Previous*100, 2)}%"),
                                       "-"))

  tab_c5 %>%
    select(laboratory_fac, val_Previous, val_Current, pct_change) %>%
    flextable() %>%
    set_header_labels(laboratory_fac = "",
                      val_Current = glue("Reporting period \nending {report_date_str_short}"),
                      val_Previous = glue("Reporting period \nending {report_date_minus7_str_short}"),
                      pct_change = "% Change") %>%
    autofit() %>%
    bold(i=1, part="header") %>%
    bold(j=1) %>%
    add_footer_lines(values = "Percent change represents change in total test returned with results.") %>%
    set_caption(caption = cap)
  
```

-----------------------------------------

### Quarantine and Isolation

```{r Figure-C5-Quar, fig.cap=cap}

  ## number in quarantine, colored by quar location, by day, all time
  ggplot(ts_quar_offcamp %>% filter(campus_fac == "UNH Durham"), aes(x=date, y=n, fill=location)) +
    geom_col(width=0.9)+
    theme_bw()+
    scale_fill_brewer("",type = "qual") +
    scale_y_continuous(name = "", breaks=breaks_pretty()) +
    scale_x_date(name="", breaks="2 weeks", limits = xaxis_entire) +
    theme(legend.position = "bottom", legend.title = element_blank())
      
  cap <- glue("**Figure C{fig_counter}**. Number in quarantine by day, by location, for the entire reporting period.")
  fig_counter <- fig_counter + 1
  
```


```{r Figure-C6-Quar-7day, fig.cap=cap}

  ## number in quarantine, colored by quar location, by day, last 7 days
  ggplot(ts_quar_offcamp %>% filter(campus_fac == "UNH Durham" & date > report_date_minus7 & date<=report_date), aes(x=date, y=n, fill=location)) +
    geom_col(width=0.9)+
    theme_bw()+
    scale_fill_brewer("",type = "qual") +
    scale_y_continuous(name = "", breaks=breaks_pretty()) +
    scale_x_date(name="", breaks="1 day", limits = xaxis_reporting) +
    theme(legend.position = "bottom", legend.title = element_blank())
      
  cap <- glue("**Figure C{fig_counter}**. Number in quarantine by day, by location, for the reporting week.")
  fig_counter <- fig_counter + 1
  
```


```{r Figure-C7-QuarBeds, fig.cap=cap}

  ## number quarantine beds in use by day
  ggplot(ts_quar_campus %>% filter(campus_fac == "UNH Durham"), aes(x=date, y=nbed)) +
    geom_col(width=0.9, fill="#120075")+
    theme_bw()+
    scale_fill_brewer("",type = "qual") +
    scale_y_continuous(name = "", breaks=breaks_pretty()) +
    scale_x_date(name="", breaks="2 weeks", limits = xaxis_entire) +
    theme(legend.position = "bottom", legend.title = element_blank()) +
    geom_hline(aes(yintercept=180), lty=2, col="red")
      
  cap <- glue("**Figure C{fig_counter}**. Number in quarantine dorm (bed) by day, by location, for the entire reporting period.")
  fig_counter <- fig_counter + 1
  
```


```{r Figure-C8-QuarBeds-7day, fig.cap=cap}

  ## number quarantine beds in use by day, past 7 days
  ggplot(ts_quar_campus %>% filter(campus_fac == "UNH Durham" & date > report_date_minus7 & date <= report_date), aes(x=date, y=nbed)) +
    geom_col(width=0.9, fill="#120075")+
    theme_bw()+
    scale_fill_brewer("",type = "qual") +
    scale_y_continuous(name = "", breaks=breaks_pretty()) +
    scale_x_date(name="", breaks="1 day", limits = xaxis_reporting) +
    theme(legend.position = "bottom", legend.title = element_blank()) +
    geom_hline(aes(yintercept=180), lty=2, col="red")
      
  cap <- glue("**Figure C{fig_counter}**. Number in quarantine dorm (bed) by day, by location, for the reporting week.")
  fig_counter <- fig_counter + 1
```


```{r Figure-C9-Isol, fig.cap=cap}
  
  ## number in isolation, colored by isolation location, by day, all time
 ggplot(ts_isol_offcamp %>% filter(campus_fac == "UNH Durham"), aes(x=date, y=n, fill=location)) +
    geom_col(width=0.9)+
    theme_bw()+
    scale_fill_brewer("",type = "qual") +
    scale_y_continuous(name = "", breaks=breaks_pretty()) +
    scale_x_date(name="", breaks="2 weeks", limits = xaxis_entire) +
    theme(legend.position = "bottom", legend.title = element_blank())
      
  cap <- glue("**Figure C{fig_counter}**. Number in isolation by day, by location, for the entire reporting period.")
  fig_counter <- fig_counter + 1
  
```


```{r Figure-C10-Isol-7day, fig.cap=cap}

  ## number in isolation, colored by isolation location, by day, last 7 days
 ggplot(ts_isol_offcamp %>% filter(campus_fac == "UNH Durham" & date > report_date_minus7 & date <= report_date), aes(x=date, y=n, fill=location)) +
    geom_col(width=0.9)+
    theme_bw()+
    scale_fill_brewer("",type = "qual") +
    scale_y_continuous(name = "", breaks=breaks_pretty()) +
    scale_x_date(name="", breaks="1 day", limits = xaxis_reporting) +
    theme(legend.position = "bottom", legend.title = element_blank())
      
  cap <- glue("**Figure C{fig_counter}**. Number in isolation by day, by location, for the reporting week.")
  fig_counter <- fig_counter + 1
  
```


```{r Figure-C11-IsolBeds, fig.cap=cap}

  ## number isolation beds in use by day
 ggplot(ts_isol_campus %>% filter(campus_fac == "UNH Durham"), aes(x=date, y=nbed)) +
    geom_col(width=0.9, fill="#120075")+
    theme_bw()+
    scale_fill_brewer("",type = "qual") +
    scale_y_continuous(name = "", breaks=breaks_pretty()) +
    scale_x_date(name="", breaks="2 weeks", limits = xaxis_entire) +
    theme(legend.position = "bottom", legend.title = element_blank()) +
    geom_hline(aes(yintercept=59), lty=2, col="red")
      
  cap <- glue("**Figure C{fig_counter}**. Number in isolation dorm (bed) by day, by location, for the entire reporting period.")
  fig_counter <- fig_counter + 1
  
```


```{r Figure-C12-IsolBeds-7day, fig.cap=cap}

  ## number isolation beds in use by day, past 7 days
 ggplot(ts_isol_campus %>% filter(campus_fac == "UNH Durham" & date > report_date_minus7 & date <= report_date), aes(x=date, y=nbed)) +
    geom_col(width=0.9, fill="#120075")+
    theme_bw()+
    scale_fill_brewer("",type = "qual") +
    scale_y_continuous(name = "", breaks=breaks_pretty()) +
    scale_x_date(name="", breaks="1 day", limits = xaxis_reporting) +
    theme(legend.position = "bottom", legend.title = element_blank()) +
    geom_hline(aes(yintercept=59), lty=2, col="red")
      
  cap <- glue("**Figure C{fig_counter}**. Number in isolation dorm (bed) by day, by location, for the reporting week.")
  fig_counter <- fig_counter + 1
  
```

-----------------------------------------

### Cumulative Confirmed Cases

```{r Table-C6-DetailedTable}

  # Cumulative cases, previous week cases, this week cases, % change this week
    # Total
    # by symptom status
    # by role
    # by age
    # by race/ethnicity
    # by sex at birth
    # by dorm area
    # by college
  
  cap <- glue("Table C{tab_counter}. Cumulative and current cases at UNH Durham.")
  tab_counter <- tab_counter + 1 
  
  cases_dur <- cases %>%
               filter(campus_fac == "UNH Durham") %>%
               mutate(level = "Total") %>%
               bind_rows(cases %>%
                         filter(campus_fac == "UNH Durham") %>%
                         filter(testdate > report_date_minus14 & testdate <= report_date) %>%
                         mutate(level = ifelse(testdate > report_date_minus7, "Current", "Previous"))) %>%
               mutate(level = factor(level, levels=c("Total", "Current", "Previous")))

  cases_tot <- cases_dur %>%
               group_by(level, .drop = FALSE) %>%
               summarise(n = n()) %>%
               pivot_wider(names_from = level, values_from = n) %>%
               mutate(var = "Total",
                      level = "")
              
  cases_role <- cases_dur %>%
                group_by(level, user_status_fac, .drop = FALSE) %>%
                summarise(n = n()) %>%
                pivot_wider(names_from = level, values_from = n) %>%
                mutate(var = "Role") %>%
                rename(level = user_status_fac)
  
  cases_age <- cases_dur %>%
               group_by(level, age_cat, .drop = FALSE) %>%
               summarise(n = n()) %>%
               pivot_wider(names_from = level, values_from = n) %>%
               mutate(var = "Age") %>%
               rename(level = age_cat)
  
  cases_gen <- cases_dur %>%
               group_by(level, gender, .drop = FALSE) %>%
               summarise(n = n()) %>%
               pivot_wider(names_from = level, values_from = n) %>%
               mutate(var = "Gender") %>%
               rename(level = gender)
  
  cases_dorm <- cases_dur %>%
                group_by(level, dorm_group, .drop = FALSE) %>%
                summarise(n = n()) %>%
                pivot_wider(names_from = level, values_from = n) %>%
                mutate(var = "Dorm") %>%
                rename(level = dorm_group) %>%
                filter(!is.na(level))
   
  cases_coll <- cases_dur %>%
                group_by(level, college_fac, .drop = FALSE) %>%
                summarise(n = n()) %>%
                pivot_wider(names_from = level, values_from = n) %>%
                mutate(var = "College") %>%
                rename(level = college_fac) %>%
                filter(!is.na(level))
  
  tab_c6 <- bind_rows(cases_tot,
                      cases_role,
                      cases_age,
                      cases_gen,
                      cases_dorm,
                      cases_coll) %>%
            select(var, level, Total, Previous, Current) %>%
            replace_na(list(Total = 0,
                            Previous = 0,
                            Current = 0)) %>%
            mutate(pct_change = ifelse(Previous>0,
                                       glue("{round((Current - Previous)/Previous*100)}%"),
                                       "-")) %>%
            mutate(Total = ifelse(Total<5 & Total>0, "<5", Total),
                   Previous = ifelse(Previous<5 & Previous>0, "<5", Previous),
                   Current = ifelse(Current<5 & Current>0, "<5", Current)) %>%
            group_by(var) %>%
            mutate(ind=1:n()) %>%
            ungroup() %>%
            mutate(var = ifelse(ind==1, var, "")) %>%
            select(-ind)
            
  tab_c6 %>%
    flextable() %>%
    set_header_labels(var = "", 
                      level="",
                      Total = "Cumulative\n(all time)",
                      Current = glue("Reporting period \nending {report_date_str_short}"),
                      Previous = glue("Reporting period \nending {report_date_minus7_str_short}"),
                      pct_change = "% Change") %>%
    bold(i=1, part="header") %>%
    bold(j=1) %>%
    autofit() %>%
    set_caption(caption=cap)
  
```


-----------------------------------------

## SECTION D: CONCORD CAMPUS (LAW)

```{r start-Concord}
  fig_counter <- 1
  tab_counter <- 1
```

```{r Table-D1-ConcordCond}

  # This Week value + Threshold Indicator, if applicable
    # total active cases from last 10 days
    # active cases per 1000 tested

  cap <- glue("Table D{tab_counter}. Concord Campus Operating Conditions.")
  tab_counter <- tab_counter + 1 
  
  indicatordf %>% 
    select(Indicator, `UNH Law`) %>%
    filter(Indicator %in% c("Active Cases", "Active Cases per 1000", "Percent Positive (7d average)")) %>%
    flextable() %>%
    bold(i=1, part="header") %>%
    set_header_labels(Indicator="",
                      `UNH Law`="Reporting Period") %>%
    autofit() %>%
    set_caption(caption = cap)%>%
    bg(i=~(Indicator == "Active Cases"), j=2, bg = active_case_colors[2]) %>%
    bg(i=~(Indicator == "Percent Positive (7d average)"), j=2, bg = pct_pos_colors[2]) 
```

-----------------------------------------

### Confirmed Cases and Testing Results

```{r Figure-D1-EpiCurve, fig.cap=cap}

  ## epi curve, new positive, all time, by day, colored by role
  ggplot(ts_cases_role %>% filter(campus_fac == "UNH Law"), aes(x=testdate, y=n, fill=user_status_fac)) +
    geom_col(width=0.9)+
    theme_bw()+
    scale_fill_brewer("Campus",type = "qual") +
    scale_y_continuous(name = "Cases", breaks=breaks_pretty()) +
    scale_x_date(name="", breaks="2 weeks", limits = xaxis_entire) +
    theme(legend.position = "bottom", legend.title = element_blank())
      
  cap <- glue("**Figure D{fig_counter}**. Newly reported positive cases, by testing date, in UNH Concord.")
  fig_counter <- fig_counter + 1
```


```{r Figure-D2-EpiCurve-7day, fig.cap=cap, eval=params$concord}

  ## epi curve, new positive, last 7 days, by day, colored by role
  ggplot(ts_cases_role %>% filter(campus_fac == "UNH Law" & testdate <= report_date & testdate > report_date_minus7), aes(x=testdate, y=n, fill=user_status_fac)) +
    geom_col(width=0.9)+
    theme_bw()+
    scale_fill_brewer("Campus",type = "qual") +
    scale_y_continuous(name = "Cases", breaks=breaks_pretty()) +
    scale_x_date(name="", breaks="1 day", limits = xaxis_reporting) +
    theme(legend.position = "bottom", legend.title = element_blank())
      
  cap <- glue("**Figure D{fig_counter}**. Newly reported positive cases, by testing date, in UNH Concord for the reporting week.")
  fig_counter <- fig_counter + 1
```


```{r Figure-D3-TestSubmitted, fig.cap=cap, eval=params$concord}
  
  ## by week, total tests submitted (including repeats), colored by role
  xbrks <- ts_test_res_wk_all$start_date[seq(1, max(ts_test_res_wk_all$weeks_prior), 2)]
  xlab <- ts_test_res_wk_all$label[seq(1, max(ts_test_res_wk_all$weeks_prior), 2)]
  
  ggplot(ts_test_res_wk_role %>% filter(campus_fac=="UNH Law"), aes(x=start_date, y=test)) +
    geom_line(color = "#120075", size=1.25) +
    scale_x_date(name="", breaks=xbrks, labels=xlab) +
    facet_wrap(.~user_status_fac, scales="free_y") +
    theme_bw() +
    theme(axis.text.x = element_text(angle=45, vjust = 1, hjust=1))

  
  cap <- glue("**Figure D{fig_counter}**. Total tests submitted per week in UNH Concord Note the different y-axis scales.")
  fig_counter <- fig_counter + 1
```


```{r Figure-D4-PropPositive, eval=params$concord}

  ## by week, # pos / (# pos + # neg)
  rng <- ceiling(max(ts_test_res_wk_camp$pct_pos[ts_test_res_wk_camp$campus_fac=="UNH Law"], na.rm = TRUE)*1000)/1000
  brks <- seq(0, rng, 0.0005)
  xbrks <- ts_test_res_wk_all$start_date
  xlab <- ts_test_res_wk_all$label
  
  ggplot(ts_test_res_wk_camp %>% filter(campus_fac == "UNH Law"), aes(x=start_date, y=pct_pos)) +
    geom_line(color = "#120075", size=1.25) +
    scale_y_continuous(name="Percent Positive", breaks=brks, labels=glue("{brks*100}%")) +
    scale_x_date(name="", breaks=xbrks, labels=xlab) +
    theme_bw() +
    theme(axis.text.x = element_text(angle=45, vjust = 1, hjust=1))
    
  cap <- glue("Figure D{fig_counter}. Proportion of positive tests over all negative and positive tests in UNH Law.")
  fig_counter <- fig_counter + 1
  
```


```{r Table-D2-OnOffCampus, eval=params$concord}

  # average number daily active cases among students, by dorm vs no dorm
    # current week
    # last week
    # % change
    # sparkline % change all time
  
  cap <- glue("Table D{tab_counter}. Average number of daily 'Active Cases' among students at UNH Concord in the reporting period and in the week prior.")
  tab_counter <- tab_counter+1
  
  tab_d2 <- ts_active_offcamp %>%
            filter(campus_fac == "UNH Law") %>%
            filter(testdate > report_date_minus14 & testdate<=report_date) %>%
            mutate(week = ifelse(testdate > report_date_minus7, "Current", "Previous")) %>%
            group_by(week, off_campus_fac) %>%
            summarise(n_active = mean(active_cases)) %>%
            pivot_wider(names_from = week, values_from = n_active) %>%
            mutate(pct_change = ifelse(Previous>0,
                                       glue("{round((Current - Previous)/Previous*100, 2)}%"),
                                       "-")) %>%
           mutate(Previous = round(Previous, 2),
                  Current = round(Current, 2),
                  off_campus_fac = recode(off_campus_fac,
                                   "On Campus" = "Dorm Listed",
                                   "Off Campus" = "Dorm Not Listed"))
            
  tab_d2 %>%
    select(off_campus_fac, Previous, Current, pct_change) %>%
    flextable() %>%
    set_header_labels(off_campus_fac = "",
                      Current = glue("Reporting period \nending {report_date_str_short}"),
                      Previous = glue("Reporting period \nending {report_date_minus7_str_short}"),
                      pct_change = "% Change") %>%
    autofit() %>%
    bold(i=1, part="header") %>%
    bold(j=1) %>%
    set_caption(caption = cap)
  
```


```{r Table-D3-MostRecentLab, eval=params$concord}

  ## by role + total, last seven days: most recent result positive, neg, incon, invalid
  cap <- glue("Table D{tab_counter}. Most recent lab result for each individual submitting a sample in the reporting period at UNH Concord.")
  tab_counter <- tab_counter + 1 
  
  recent_rep_law <- demo_testing_recent %>%
                    filter(campus_fac == "UNH Law") %>%
                    ungroup() %>%
                    group_by(user_status_fac, .drop = FALSE) %>%
                    select(pos, neg, incon, invalid) %>%
                    summarise_all(sum)

  recent_total_law <- demo_testing_recent %>%
                      filter(campus_fac == "UNH Law") %>%
                      ungroup() %>%
                      select(pos, neg, incon, invalid) %>%
                      summarise_all(sum) %>%
                      mutate(user_status_fac = "Total (reporting week)")
  
  tab_d3 <- bind_rows(recent_rep_dur, recent_total_dur) %>%
            filter(user_status_fac != "Employee") %>%
            mutate(user_status_fac = ifelse(user_status_fac=="Unknown", "Contractors and Visitors", user_status_fac)) %>%
            rename(`Positive` = pos,
                   `Negative` = neg,
                   `Inconclusive` = incon,
                   `Invalid` = invalid,
                   ` ` = user_status_fac)

  tab_d3 %>%
    flextable() %>%
    autofit() %>%
    hline(i=4, part="body", border=fp_border(width=2)) %>%
    bold(i=1, part="header") %>%
    bold(j=1) %>%
    set_caption(caption=cap)
  
```


```{r Table-D4-TestSubmitted, eval=params$concord}
  
  ## by role in last week, cumulative in last week and all time:
    # total tests submitted
    # unique IDs submitting (as prop of all IDs not previously positive)
    # tests per unique ID
  
  cap <- glue("Table D{tab_counter}. Tests submitted including repeats at UNH Concord.")
  tab_counter <- tab_counter + 1 
  
  ntest_rep <- ts_test_res %>%
               filter(campus_fac == "UNH Law") %>%
               filter(testdate > report_date_minus7 & testdate <= report_date) %>%
               group_by(user_status_fac, .drop = FALSE) %>%
               summarise(n_tests = sum(test)) %>%
               rename(label = user_status_fac)
  ntest_total <- ts_test_res %>%
                 filter(campus_fac == "UNH Law") %>%
                 filter(testdate > report_date_minus7 & testdate <= report_date) %>%
                 summarise(n_tests = sum(test)) %>%
                 mutate(label = "Total (reporting week)")
  ntest_cum <- ts_test_res %>%
               filter(campus_fac == "UNH Law") %>%
               summarise(n_tests = sum(test)) %>%
               mutate(label = "Cumulative (all time)")
  ntest <- bind_rows(ntest_rep, ntest_total, ntest_cum)
  
  nid_rep <- demo_testing_sum %>%
             filter(campus_fac == "UNH Law") %>%
             group_by(user_status_fac, .drop = FALSE) %>%
             summarise(n_id = sum(tested_7day)) %>%
             rename(label = user_status_fac)
  nid_total <- demo_testing_sum %>%
               filter(campus_fac == "UNH Law") %>%
               summarise(n_id = sum(tested_7day)) %>%
               mutate(label = "Total (reporting week)")
  nid_cum <- demo_testing_sum %>%
             filter(campus_fac == "UNH Law") %>%
             summarise(n_id = sum(n_test>0, na.rm=TRUE)) %>%
             mutate(label = "Cumulative (all time)")
  nid <- bind_rows(nid_rep, nid_total, nid_cum)
  
  tab_d4 <- left_join(ntest, nid) %>%
            mutate(n_test_per_id = round(n_tests / n_id, 2)) %>%
            mutate(label = ifelse(label=="Unknown", "Contractors and Visitors", label)) %>%
            filter(label != "Employee") %>%
            rename(`Total Tests Submitted` = n_tests,
                   `Unique IDs Submitting` = n_id,
                   `Tests Submitted per ID` = n_test_per_id,
                   ` ` = label)
  
  tab_d4 %>% 
    flextable() %>%
    autofit() %>%
    hline(i=4, part="body", border=fp_border(width=2)) %>%
    bold(i=1, part="header") %>%
    bold(j=1) %>%
    add_footer_lines(values="All values presented for the current reporting week, unless otherwise noted.") %>%
    set_caption(caption=cap)
  
```


```{r Table-D5-Lab, eval=params$concord}

  # total number tests submitted by lab, last week + current week, sparkline weekly average over time
  
  cap <- glue("Table D{tab_counter}. Laboratory operations (as number of tests returned with results and percent of all tests submitted) at UNH Concord in the reporting period and in the week prior.")
  tab_counter <- tab_counter+1
  
  tab_d5 <- ts_test_lab %>%
            filter(campus_fac == "UNH Law") %>%
            filter(testdate > report_date_minus14 & testdate<=report_date) %>%
            mutate(week = ifelse(testdate > report_date_minus7, "Current", "Previous")) %>%
            group_by(week, laboratory_fac) %>%
            summarise(n_test = sum(n_test),
                      n_res = sum(n_with_res),
                      pct_res = round(n_res/n_test*100, 1),
                      val = glue("{n_res} ({pct_res}%)")) %>%
            select(-n_test, -pct_res) %>%
            pivot_wider(names_from = week, values_from = c(val, n_res)) %>%
            mutate(pct_change = ifelse(n_res_Previous>0,
                                       glue("{round((n_res_Current - n_res_Previous)/n_res_Previous*100, 2)}%"),
                                       "-"))

  tab_d5 %>%
    select(laboratory_fac, val_Previous, val_Current, pct_change) %>%
    flextable() %>%
    set_header_labels(laboratory_fac = "",
                      val_Current = glue("Reporting period \nending {report_date_str_short}"),
                      val_Previous = glue("Reporting period \nending {report_date_minus7_str_short}"),
                      pct_change = "% Change") %>%
    autofit() %>%
    bold(i=1, part="header") %>%
    bold(j=1) %>%
    add_footer_lines(values = "Percent change represents change in total test returned with results.") %>%
    set_caption(caption=cap)
  
```

-----------------------------------------

### Quarantine and Isolation

```{r Figure-D5-Quar, fig.cap=cap, eval=params$concord}

  ## number in quarantine, colored by quar location, by day, all time
 ggplot(ts_quar_offcamp %>% filter(campus_fac == "UNH Law"), aes(x=date, y=n, fill=location)) +
    geom_col(width=0.9)+
    theme_bw()+
    scale_fill_brewer("",type = "qual") +
    scale_y_continuous(name = "", breaks=breaks_pretty()) +
    scale_x_date(name="", breaks="2 weeks", limits = xaxis_entire) +
    theme(legend.position = "bottom", legend.title = element_blank())
      
  cap <- glue("Figure D{fig_counter}. Number in quarantine by day, by location, for the entire reporting period.")
  fig_counter <- fig_counter + 1
  
```


```{r Figure-D6-Quar-7day, fig.cap=cap, eval=params$concord}

  ## number in quarantine, colored by quar location, by day, last 7 days
 ggplot(ts_quar_offcamp %>% filter(campus_fac == "UNH Law" & date > report_date_minus7 & date <= report_date), aes(x=date, y=n, fill=location)) +
    geom_col(width=0.9)+
    theme_bw()+
    scale_fill_brewer("",type = "qual") +
    scale_y_continuous(name = "", breaks=breaks_pretty()) +
    scale_x_date(name="", breaks="1 day", limits = xaxis_reporting) +
    theme(legend.position = "bottom", legend.title = element_blank())
      
  cap <- glue("Figure D{fig_counter}. Number in quarantine by day, by location, for the reporting week.")
  fig_counter <- fig_counter + 1
  
```


```{r Figure-D7-Isol, fig.cap=cap, eval=params$concord}
  
  ## number in isolation, colored by isolation location, by day, all time
 ggplot(ts_isol_offcamp %>% filter(campus_fac == "UNH Law"), aes(x=date, y=n, fill=location)) +
    geom_col(width=0.9)+
    theme_bw()+
    scale_fill_brewer("",type = "qual") +
    scale_y_continuous(name = "", breaks=breaks_pretty()) +
    scale_x_date(name="", breaks="2 weeks", limits = xaxis_entire) +
    theme(legend.position = "bottom", legend.title = element_blank())
      
  cap <- glue("Figure D{fig_counter}. Number in isolation by day, by location, for the entire reporting period")
  fig_counter <- fig_counter + 1
  
```


```{r Figure-D8-Isol-7day, fig.cap=cap, eval=params$concord}

  ## number in isolation, colored by isolation location, by day, last 7 days
 ggplot(ts_isol_offcamp %>% filter(campus_fac == "UNH Law" & date > report_date_minus7 & date <= report_date), aes(x=date, y=n, fill=location)) +
    geom_col(width=0.9)+
    theme_bw()+
    scale_fill_brewer("",type = "qual") +
    scale_y_continuous(name = "", breaks=breaks_pretty()) +
    scale_x_date(name="", breaks="1 day", limits = xaxis_reporting) +
    theme(legend.position = "bottom", legend.title = element_blank())
      
  cap <- glue("Figure D{fig_counter}. Number in isolation by day, by location, for the reporting week.")
  fig_counter <- fig_counter + 1
  
```

-----------------------------------------

### Cumulative Confirmed Cases

```{r Table-D6-DetailedTable, eval=params$concord}

  # Cumulative cases, previous week cases, this week cases, % change this week
    # Total
    # by symptom status
    # by role
    # by age
    # by race/ethnicity
    # by sex at birth
    # by dorm area
    # by college
  
  cap <- glue("Table D{tab_counter}. Cumulative and current cases at UNH Concord")
  tab_counter <- tab_counter + 1 
  
  cases_law <- cases %>%
               filter(campus_fac == "UNH Law") %>%
               mutate(level = "Total") 
  if(nrow(cases_law)==0){ 
    print("No cases in UNH Concord for reporting period")}else{
 
    cases_law <- cases_law %>% mutate(level = factor(level, levels=c("Total", "Current", "Previous")))
  
    cases_tot <- cases_law %>%
                 group_by(level, .drop = FALSE) %>%
                 summarise(n = n()) %>%
                 pivot_wider(names_from = level, values_from = n) %>%
                 mutate(var = "Total",
                        level = "")
                
    cases_role <- cases_law %>%
                  group_by(level, user_status_fac, .drop = FALSE) %>%
                  summarise(n = n()) %>%
                  pivot_wider(names_from = level, values_from = n) %>%
                  mutate(var = "Role") %>%
                  rename(level = user_status_fac)
    
    cases_age <- cases_law %>%
                 group_by(level, age_cat, .drop = FALSE) %>%
                 summarise(n = n()) %>%
                 pivot_wider(names_from = level, values_from = n) %>%
                 mutate(var = "Age") %>%
                 rename(level = age_cat)
    
    cases_gen <- cases_law %>%
                 group_by(level, gender, .drop = FALSE) %>%
                 summarise(n = n()) %>%
                 pivot_wider(names_from = level, values_from = n) %>%
                 mutate(var = "Gender") %>%
                 rename(level = gender)
    
    cases_dorm <- cases_law %>%
                  group_by(level, dorm_group, .drop = FALSE) %>%
                  summarise(n = n()) %>%
                  pivot_wider(names_from = level, values_from = n) %>%
                  mutate(var = "Dorm") %>%
                  rename(level = dorm_group)  %>%
                  filter(!is.na(level))
     
    cases_coll <- cases_law %>%
                  group_by(level, college_fac, .drop = FALSE) %>%
                  summarise(n = n()) %>%
                  pivot_wider(names_from = level, values_from = n) %>%
                  mutate(var = "College") %>%
                  rename(level = college_fac) %>%
                  filter(!is.na(level))
    
    tab_d6 <- bind_rows(cases_tot,
                        cases_role,
                        cases_age,
                        cases_gen,
                        cases_dorm,
                        cases_coll) %>%
              select(var, level, Total, Previous, Current) %>%
              replace_na(list(Total = 0,
                              Previous = 0,
                              Current = 0)) %>%
              mutate(pct_change = ifelse(Previous>0,
                                         glue("{round((Current - Previous)/Previous*100, 1)}%"),
                                         "-")) %>%
              mutate(Total = ifelse(Total<5 & Total>0, "<5", Total),
                     Previous = ifelse(Previous<5 & Previous>0, "<5", Previous),
                     Current = ifelse(Current<5 & Current>0, "<5", Current)) %>%
              group_by(var) %>%
              mutate(ind=1:n()) %>%
              ungroup() %>%
              mutate(var = ifelse(ind==1, var, "")) %>%
              select(-ind)
              
    tab_d6 %>%
      flextable() %>%
      set_header_labels(var = "", 
                        level="",
                        Total = "Cumulative\n(all time)",
                        Current = glue("Reporting period \nending {report_date_str_short}"),
                        Previous = glue("Reporting period \nending {report_date_minus7_str_short}"),
                        pct_change = "% Change") %>%
      bold(i=1, part="header") %>%
      bold(j=1) %>%
      autofit() %>%
      set_caption(caption=cap)
    }
  
```


-----------------------------------------

## SECTION E: MANCHESTER CAMPUS

```{r start-Manchester}
  fig_counter <- 1
  tab_counter <- 1
```


```{r Table-E1-ManchCond}

  # This Week value + Threshold Indicator, if applicable
    # total active cases from last 10 days
    # active cases per 1000 tested

  cap <- glue("Table E{tab_counter}. Manchester Campus Operating Conditions.")
  tab_counter <- tab_counter + 1 
  
  indicatordf %>% 
    select(Indicator, `UNH Manchester`) %>%
    filter(Indicator %in% c("Active Cases", "Active Cases per 1000", "Percent Positive (7d average)")) %>%
    flextable() %>%
    bold(i=1, part="header") %>%
    set_header_labels(Indicator="",
                      `UNH Manchester`="Reporting Period") %>%
    autofit() %>%
    set_caption(caption=cap)%>%
    bg(i=~(Indicator == "Active Cases"), j=2, bg = active_case_colors[3]) %>%
    bg(i=~(Indicator == "Percent Positive (7d average)"), j=2, bg = pct_pos_colors[3]) 

```

-----------------------------------------

### Confirmed Cases and Testing Results

```{r Figure-E1-EpiCurve, fig.cap=cap}

  ## epi curve, new positive, all time, by day, colored by role
  ggplot(ts_cases_role %>% filter(campus_fac == "UNH Manchester"), aes(x=testdate, y=n, fill=user_status_fac)) +
    geom_col(width=0.9)+
    theme_bw()+
    scale_fill_brewer("Campus",type = "qual") +
    scale_y_continuous(name = "Cases", breaks=breaks_pretty()) +
    scale_x_date(name="", breaks="2 weeks", limits = xaxis_entire) +
    theme(legend.position = "bottom", legend.title = element_blank())
      
  cap <- glue("Figure E{fig_counter}. Newly reported positive cases, by testing date, in UNH Manchester.")
  fig_counter <- fig_counter + 1
  
```


```{r Figure-E2-EpiCurve-7day, fig.cap=cap, eval=params$manchester}

  ## epi curve, new positive, last 7 days, by day, colored by role
  ggplot(ts_cases_role %>% filter(campus_fac == "UNH Manchester" & testdate <= report_date & testdate > report_date_minus7), aes(x=testdate, y=n, fill=user_status_fac)) +
    geom_col(width=0.9)+
    theme_bw()+
    scale_fill_brewer("Campus",type = "qual") +
    scale_y_continuous(name = "Cases", breaks=breaks_pretty()) +
    scale_x_date(name="", breaks="1 day", limits = xaxis_reporting) +
    theme(legend.position = "bottom", legend.title = element_blank())
      
  cap <- glue("Figure E{fig_counter}. Newly reported positive cases, by testing date, in UNH Manchester for the reporting week.")
  fig_counter <- fig_counter + 1
  
```


```{r Figure-E3-TestSubmitted, fig.cap=cap, eval=params$manchester}
  
  xbrks <- ts_test_res_wk_all$start_date[seq(1, max(ts_test_res_wk_all$weeks_prior), 2)]
  xlab <- ts_test_res_wk_all$label[seq(1, max(ts_test_res_wk_all$weeks_prior), 2)]
  
  ## by week, total tests submitted (including repeats), colored by role
  ggplot(ts_test_res_wk_role %>% filter(campus_fac=="UNH Manchester"), aes(x=start_date, y=test)) +
    geom_line(color = "#120075", size=1.25) +
    scale_x_date(name="", breaks=xbrks, labels=xlab) +
    facet_wrap(.~user_status_fac, scales="free_y") +
    theme_bw() +
    theme(axis.text.x = element_text(angle=45, vjust = 1, hjust=1))

  cap <- glue("Figure E{fig_counter}. Total tests submitted per week in UNH Manchester. Note the different y-axis scales.")
  fig_counter <- fig_counter + 1
  
```


```{r Figure-E4-PropPositive, fig.cap=cap, eval=params$manchester}

  ## by week, # pos / (# pos + # neg)
  rng <- ceiling(max(ts_test_res_wk_camp$pct_pos[ts_test_res_wk_camp$campus_fac=="UNH Manchester"], na.rm = TRUE)*1000)/1000
  brks <- seq(0, rng, 0.0005)
  xbrks <- ts_test_res_wk_all$start_date
  xlab <- ts_test_res_wk_all$label
  
  ggplot(ts_test_res_wk_camp %>% filter(campus_fac == "UNH Manchester"), aes(x=start_date, y=pct_pos)) +
    geom_line(color = "#120075", size=1.25) +
    scale_y_continuous(name="Percent Positive", breaks=brks, labels=glue("{brks*100}%")) +
    scale_x_date(name="", breaks=xbrks, labels=xlab) +
    theme_bw() +
    theme(axis.text.x = element_text(angle=45, vjust = 1, hjust=1))
    
  cap <- glue("Figure E{fig_counter}. Proportion of positive tests over all negative and positive tests in UNH Manchester")
  fig_counter <- fig_counter + 1
  
```


```{r Table-E2-OnOffCampus, eval=params$manchester}

  # average number daily active cases among students, by dorm vs no dorm
    # current week
    # last week
    # % change
    # sparkline % change all time
  
  cap <- glue("Table E{tab_counter}. Average number of daily 'Active Cases' among students at UNH Manchester in the reporting period and in the week prior.")
  tab_counter <- tab_counter+1
  
  tab_e2 <- ts_active_offcamp %>%
            filter(campus_fac == "UNH Manchester") %>%
            filter(testdate > report_date_minus14 & testdate<=report_date) %>%
            mutate(week = ifelse(testdate > report_date_minus7, "Current", "Previous")) %>%
            group_by(week, off_campus_fac) %>%
            summarise(n_active = mean(active_cases)) %>%
            pivot_wider(names_from = week, values_from = n_active) %>%
            mutate(pct_change = ifelse(Previous>0,
                                       glue("{round((Current - Previous)/Previous*100, 2)}%"),
                                       "-")) %>%
           mutate(Previous = round(Previous, 2),
                  Current = round(Current, 2),
                  off_campus_fac = recode(off_campus_fac,
                                   "On Campus" = "Dorm Listed",
                                   "Off Campus" = "Dorm Not Listed"))
            
  tab_e2 %>%
    select(off_campus_fac, Previous, Current, pct_change) %>%
    flextable() %>%
    set_header_labels(off_campus_fac = "",
                      Current = glue("Reporting period \nending {report_date_str_short}"),
                      Previous = glue("Reporting period \nending {report_date_minus7_str_short}"),
                      pct_change = "% Change") %>%
    autofit() %>%
    bold(i=1, part="header") %>%
    bold(j=1) %>%
    set_caption(caption=cap)

```


```{r Table-E3-MostRecentLab, eval=params$manchester}

  ## by role + total, last seven days: most recent result positive, neg, incon, invalid
    
  cap <- glue("Table E{tab_counter}. Most recent lab result for each individual submitting a sample in the reporting period at UNH Manchester")
  tab_counter <- tab_counter + 1 
  
  recent_rep_man <- demo_testing_recent %>%
                    filter(campus_fac == "UNH Manchester") %>%
                    ungroup() %>%
                    group_by(user_status_fac, .drop = FALSE) %>%
                    select(pos, neg, incon, invalid) %>%
                    summarise_all(sum)

  recent_total_man <- demo_testing_recent %>%
                      filter(campus_fac == "UNH Manchester") %>%
                      ungroup() %>%
                      select(pos, neg, incon, invalid) %>%
                      summarise_all(sum) %>%
                      mutate(user_status_fac = "Total (reporting week)")
  
  tab_e3 <- bind_rows(recent_rep_dur, recent_total_dur) %>%
            filter(user_status_fac != "Employee") %>%
            mutate(user_status_fac = ifelse(user_status_fac=="Unknown", "Contractors and Visitors", user_status_fac)) %>%
            rename(`Positive` = pos,
                   `Negative` = neg,
                   `Inconclusive` = incon,
                   `Invalid` = invalid,
                   ` ` = user_status_fac)

  tab_e3 %>%
    flextable() %>%
    autofit() %>%
    hline(i=4, part="body", border=fp_border(width=2)) %>%
    bold(i=1, part="header") %>%
    bold(j=1) %>%
    set_caption(caption=cap)
  
```


```{r Table-E4-TestSubmitted, eval=params$manchester}
  
  ## by role in last week, cumulative in last week and all time:
    # total tests submitted
    # unique IDs submitting (as prop of all IDs not previously positive)
    # tests per unique ID
  
  cap <- glue("Table E{tab_counter}. Tests submitted including repeats at UNH Manchester.")
  tab_counter <- tab_counter + 1 
  
  ntest_rep <- ts_test_res %>%
               filter(campus_fac == "UNH Manchester") %>%
               filter(testdate > report_date_minus7 & testdate <= report_date) %>%
               group_by(user_status_fac, .drop = FALSE) %>%
               summarise(n_tests = sum(test)) %>%
               rename(label = user_status_fac)
  ntest_total <- ts_test_res %>%
                 filter(campus_fac == "UNH Manchester") %>%
                 filter(testdate > report_date_minus7 & testdate <= report_date) %>%
                 summarise(n_tests = sum(test)) %>%
                 mutate(label = "Total (reporting week)")
  ntest_cum <- ts_test_res %>%
               filter(campus_fac == "UNH Manchester") %>%
               summarise(n_tests = sum(test)) %>%
               mutate(label = "Cumulative (all time)")
  ntest <- bind_rows(ntest_rep, ntest_total, ntest_cum)
  
  nid_rep <- demo_testing_sum %>%
             filter(campus_fac == "UNH Manchester") %>%
             group_by(user_status_fac, .drop = FALSE) %>%
             summarise(n_id = sum(tested_7day)) %>%
             rename(label = user_status_fac)
  nid_total <- demo_testing_sum %>%
               filter(campus_fac == "UNH Manchester") %>%
               summarise(n_id = sum(tested_7day)) %>%
               mutate(label = "Total (reporting week)")
  nid_cum <- demo_testing_sum %>%
             filter(campus_fac == "UNH Manchester") %>%
             summarise(n_id = sum(n_test>0, na.rm=TRUE)) %>%
             mutate(label = "Cumulative (all time)")
  nid <- bind_rows(nid_rep, nid_total, nid_cum)
  
  tab_e4 <- left_join(ntest, nid) %>%
            mutate(n_test_per_id = round(n_tests / n_id, 2)) %>%
            mutate(label = ifelse(label=="Unknown", "Contractors and Visitors", label)) %>%
            filter(label != "Employee") %>%
            rename(`Total Tests Submitted` = n_tests,
                   `Unique IDs Submitting` = n_id,
                   `Tests Submitted per ID` = n_test_per_id,
                   ` ` = label)
  
  tab_e4 %>% 
    flextable() %>%
    autofit() %>%
    hline(i=4, part="body", border=fp_border(width=2)) %>%
    bold(i=1, part="header") %>%
    bold(j=1) %>%
    add_footer_lines(values="All values presented for the current reporting week, unless otherwise noted.") %>%
    set_caption(caption=cap)

```


```{r Table-E5-Lab, eval=params$manchester}

  # total number tests submitted by lab, last week + current week, sparkline weekly average over time
    
  cap <- glue("Table E{tab_counter}. Laboratory operations (as number of tests returned with results and percent of all tests submitted) at UNH Manchester in the reporting period and in the week prior.")
  tab_counter <- tab_counter+1
  
  tab_d5 <- ts_test_lab %>%
            filter(campus_fac == "UNH Manchester") %>%
            filter(testdate > report_date_minus14 & testdate<=report_date) %>%
            mutate(week = ifelse(testdate > report_date_minus7, "Current", "Previous")) %>%
            group_by(week, laboratory_fac) %>%
            summarise(n_test = sum(n_test),
                      n_res = sum(n_with_res),
                      pct_res = round(n_res/n_test*100, 1),
                      val = glue("{n_res} ({pct_res}%)")) %>%
            select(-n_test, -pct_res) %>%
            pivot_wider(names_from = week, values_from = c(val, n_res)) %>%
            mutate(pct_change = ifelse(n_res_Previous>0,
                                       glue("{round((n_res_Current - n_res_Previous)/n_res_Previous*100, 2)}%"),
                                       "-"))

  tab_d5 %>%
    select(laboratory_fac, val_Previous, val_Current, pct_change) %>%
    flextable() %>%
    set_header_labels(laboratory_fac = "",
                      val_Current = glue("Reporting period \nending {report_date_str_short}"),
                      val_Previous = glue("Reporting period \nending {report_date_minus7_str_short}"),
                      pct_change = "% Change") %>%
    autofit() %>%
    bold(i=1, part="header") %>%
    bold(j=1) %>%
    add_footer_lines(values = "Percent change represents change in total test returned with results.") %>%
    set_caption(caption=cap)
  
```

-----------------------------------------

### Quarantine and Isolation

```{r Figure-E5-Quar, fig.cap=cap, eval=params$manchester}

  ## number in quarantine, colored by quar location, by day, all time
 ggplot(ts_quar_offcamp %>% filter(campus_fac == "UNH Manchester"), aes(x=date, y=n, fill=location)) +
    geom_col(width=0.9)+
    theme_bw()+
    scale_fill_brewer("",type = "qual") +
    scale_y_continuous(name = "", breaks=breaks_pretty()) +
    scale_x_date(name="", breaks="2 weeks", limits = xaxis_entire) +
    theme(legend.position = "bottom", legend.title = element_blank())
      
  cap <- glue("Figure E{fig_counter}. Number in quarantine by day, by location, for the entire reporting period.")
  fig_counter <- fig_counter + 1
  
```


```{r Figure-E6-Quar-7day, fig.cap=cap, eval=params$manchester}

  ## number in quarantine, colored by quar location, by day, last 7 days
 ggplot(ts_quar_offcamp %>% filter(campus_fac == "UNH Manchester" & date > report_date_minus7 & date <= report_date), aes(x=date, y=n, fill=location)) +
    geom_col(width=0.9)+
    theme_bw()+
    scale_fill_brewer("",type = "qual") +
    scale_y_continuous(name = "", breaks=breaks_pretty()) +
    scale_x_date(name="", breaks="1 day", limits = xaxis_reporting) +
    theme(legend.position = "bottom", legend.title = element_blank())
      
  cap <- glue("Figure E{fig_counter}. Number in quarantine by day, by location, for the reporting week.")
  fig_counter <- fig_counter + 1
  
```


```{r Figure-E7-Isol, fig.cap=cap, eval=params$manchester}
  
  ## number in isolation, colored by isolation location, by day, all time
 ggplot(ts_isol_offcamp %>% filter(campus_fac == "UNH Manchester"), aes(x=date, y=n, fill=location)) +
    geom_col(width=0.9)+
    theme_bw()+
    scale_fill_brewer("",type = "qual") +
    scale_y_continuous(name = "", breaks=breaks_pretty()) +
    scale_x_date(name="", breaks="2 weeks", limits = xaxis_entire) +
    theme(legend.position = "bottom", legend.title = element_blank())
      
  cap <- glue("Figure E{fig_counter}. Number in isolation by day, by location, for the entire reporting period.")
  fig_counter <- fig_counter + 1
```


```{r Figure-E8-Isol-7day, fig.cap=cap, eval=params$manchester}

  ## number in isolation, colored by isolation location, by day, last 7 days
 ggplot(ts_isol_offcamp %>% filter(campus_fac == "UNH Manchester" & date > report_date_minus7 & date <= report_date), aes(x=date, y=n, fill=location)) +
    geom_col(width=0.9)+
    theme_bw()+
    scale_fill_brewer("",type = "qual") +
    scale_y_continuous(name = "", breaks=breaks_pretty()) +
    scale_x_date(name="", breaks="1 day", limits = xaxis_reporting) +
    theme(legend.position = "bottom", legend.title = element_blank())
      
  cap <- glue("Figure E{fig_counter}. Number in isolation by day, by location, for the reporting week.")
  fig_counter <- fig_counter + 1
```


-----------------------------------------

### Cumulative Confirmed Cases

```{r Table-E6-DetailedTable, eval=params$manchester}

  # Cumulative cases, previous week cases, this week cases, % change this week
    # Total
    # by symptom status
    # by role
    # by age
    # by race/ethnicity
    # by sex at birth
    # by dorm area
    # by college

  cap <- glue("Table E{tab_counter}. Cumulative and current cases at UNH Manchester.")
  tab_counter <- tab_counter + 1  
  
  cases_man <- cases %>%
               filter(campus_fac == "UNH Manchester") %>%
               mutate(level = "Total") %>%
               bind_rows(cases %>%
                         filter(campus_fac == "UNH Manchester") %>%
                         filter(testdate > report_date_minus14 & testdate <= report_date) %>%
                         mutate(level = ifelse(testdate > report_date_minus7, "Current", "Previous"))) %>%
               mutate(level = factor(level, levels=c("Total", "Current", "Previous")))

  cases_tot <- cases_man %>%
               group_by(level, .drop = FALSE) %>%
               summarise(n = n()) %>%
               pivot_wider(names_from = level, values_from = n) %>%
               mutate(var = "Total",
                      level = "")
              
  cases_role <- cases_man %>%
                group_by(level, user_status_fac, .drop = FALSE) %>%
                summarise(n = n()) %>%
                pivot_wider(names_from = level, values_from = n) %>%
                mutate(var = "Role") %>%
                rename(level = user_status_fac)
  
  cases_age <- cases_man %>%
               group_by(level, age_cat, .drop = FALSE) %>%
               summarise(n = n()) %>%
               pivot_wider(names_from = level, values_from = n) %>%
               mutate(var = "Age") %>%
               rename(level = age_cat)
  
  cases_gen <- cases_man %>%
               group_by(level, gender, .drop = FALSE) %>%
               summarise(n = n()) %>%
               pivot_wider(names_from = level, values_from = n) %>%
               mutate(var = "Gender") %>%
               rename(level = gender)
  
  cases_dorm <- cases_man %>%
                group_by(level, dorm_group, .drop = FALSE) %>%
                summarise(n = n()) %>%
                pivot_wider(names_from = level, values_from = n) %>%
                mutate(var = "Dorm") %>%
                rename(level = dorm_group) %>%
                filter(!is.na(level))
   
  cases_coll <- cases_man %>%
                group_by(level, college_fac, .drop = FALSE) %>%
                summarise(n = n()) %>%
                pivot_wider(names_from = level, values_from = n) %>%
                mutate(var = "College") %>%
                rename(level = college_fac) %>%
                filter(!is.na(level))
  
  tab_e6 <- bind_rows(cases_tot,
                      cases_role,
                      cases_age,
                      cases_gen,
                      cases_dorm,
                      cases_coll) %>%
            select(var, level, Total, Previous, Current) %>%
            replace_na(list(Total = 0,
                            Previous = 0,
                            Current = 0)) %>%
            mutate(pct_change = ifelse(Previous>0,
                                       glue("{round((Current - Previous)/Previous*100, 1)}%"),
                                       "-")) %>%
            mutate(Total = ifelse(Total<5 & Total>0, "<5", Total),
                   Previous = ifelse(Previous<5 & Previous>0, "<5", Previous),
                   Current = ifelse(Current<5 & Current>0, "<5", Current)) %>%
            group_by(var) %>%
            mutate(ind=1:n()) %>%
            ungroup() %>%
            mutate(var = ifelse(ind==1, var, "")) %>%
            select(-ind)
            
  tab_e6 %>%
    flextable() %>%
    set_header_labels(var = "", 
                      level="",
                      Total = "Cumulative\n(all time)",
                      Current = glue("Reporting period \nending {report_date_str_short}"),
                      Previous = glue("Reporting period \nending {report_date_minus7_str_short}"),
                      pct_change = "% Change") %>%
    bold(i=1, part="header") %>%
    bold(j=1) %>%
    autofit() %>%
    set_caption(caption=cap)
  
```

